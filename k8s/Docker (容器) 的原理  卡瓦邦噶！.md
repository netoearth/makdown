第一次接触 docker 的人可能都会对它感到神奇，一行 `docker run`，就能创建出来一个类似虚拟机的隔离环境，里面的依赖都是 reproduceable 的！然而这里面并没有什么魔法，有人说 Docker 并没有发明什么新的技术。确实是，它只不过是将一些 [Linux 已经有的功能](https://avatao.com/life-before-docker-and-beyond-a-brief-history-of-container-security/)集合在一起，提供了一个简单的 UI 来创建“容器”。

这篇文章用来介绍容器的原理。

什么是一个容器？我们从容器的标准开始说起。

## 一、OCI Specification

OCI 现在是容器的事实标准，它规定了两部分的标准：

1.  Image spec：容器如何打包
2.  Runtime spec：容器如何运行

[![](https://www.kawabangga.com/wp-content/uploads/2021/04/Canvas-2-1024x286.png)](https://www.kawabangga.com/wp-content/uploads/2021/04/Canvas-2.png)

### Image Spec

容器的运行时是通过 Image 创建的，Image Spec 规定了这个 Image 里面要放什么文件。本质上，一个 Image 就是一个 tar 包。里面一般包含这些内容：

<table><tbody><tr><td data-settings="show"></td><td><div><p>├──<span> </span><span>blobs</span></p><p>│<span>&nbsp;&nbsp; </span>└──<span> </span><span>sha256</span></p><p>│<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>├──<span> </span><span>4297f01aae8e36da1ec85e36a3cc5a4b11aa34bcaa1d88cc9ca09469826cb2bf</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>image</span><span>.</span><span>manifest</span><span>)</span></p><p>│<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>└──<span> </span><span>7ea0496f252ea46535ea6932dc460cb7d82bfc86875d9d2586b6afa1e8807ad0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>image</span><span>.</span><span>config</span><span>)</span><span>&nbsp;&nbsp;</span></p><p>├──<span> </span><span>index</span><span>.</span><span>json</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p>└──<span> </span><span>oci</span><span>-</span><span>layout</span></p></div></td></tr></tbody></table>

`manifest` 里面包含 `config` 和 `layers`，其中 [config](https://github.com/opencontainers/image-spec/blob/master/config.md) 包含以下内容的配置：

1.  创建运行时(container)的时候需要的配置；
2.  layers的配置
3.  image 的 metadata

[`layers`](https://github.com/opencontainers/image-spec/blob/master/layer.md) 就是组成 rootfs 的一些文件。base 层的 layer 有所有的文件，之后的 layer 只保存基于 base 层的 changes。在创建容器的时候需要打开这个 Image，先找到 base layer，然后将之后的 layer 一个一个地 apply changes，得到最后的 rootfs。

[![](https://www.kawabangga.com/wp-content/uploads/2021/04/Canvas-3.png)](https://www.kawabangga.com/wp-content/uploads/2021/04/Canvas-3.png)

我们可以下载一个 Nginx 的 Docker Image 来看下里面都有什么。

首先 pull 下来 docker 的 image，然后将它保存为一个 tar 文件。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>docker </span><span>pull </span><span>nginx</span></p><p><span>Using </span><span>default </span><span>tag</span><span>:</span><span> </span><span>latest</span></p><p><span>latest</span><span>:</span><span> </span><span>Pulling </span><span>from</span><span> </span><span>library</span><span>/</span><span>nginx</span></p><p><span>75646c2fb410</span><span>:</span><span> </span><span>Pull </span><span>complete</span></p><p><span>6128033c842f</span><span>:</span><span> </span><span>Pull </span><span>complete</span></p><p><span>71a81b5270eb</span><span>:</span><span> </span><span>Pull </span><span>complete</span></p><p><span>b5fc821c48a1</span><span>:</span><span> </span><span>Pull </span><span>complete</span></p><p><span>da3f514a6428</span><span>:</span><span> </span><span>Pull </span><span>complete</span></p><p><span>3be359fed358</span><span>:</span><span> </span><span>Pull </span><span>complete</span></p><p><span>Digest</span><span>:</span><span> </span><span>sha256</span><span>:</span><span>bae781e7f518e0fb02245140c97e6ddc9f5fcf6aecc043dd9d17e33aec81c832</span></p><p><span>Status</span><span>:</span><span> </span><span>Downloaded </span><span>newer </span><span>image </span><span>for</span><span> </span><span>nginx</span><span>:</span><span>latest</span></p><p><span>docker</span><span>.</span><span>io</span><span>/</span><span>library</span><span>/</span><span>nginx</span><span>:</span><span>latest</span></p><p><span># docker save nginx -o nginx_image.tar</span></p></div></td></tr></tbody></table>

然后再把它解压开：

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p></div></td><td><div><p><span>$</span><span> </span><span>tar </span><span>xvf </span><span>nginx_image</span><span>.</span><span>tar</span><span> </span><span>-</span><span>C</span><span> </span><span>nginx</span></p><p><span>x</span><span> </span><span>241e50a7915c1c9d7e9ddaa9118295fa448168f9aa9cc80b186b58f56122a072</span><span>/</span></p><p><span>x</span><span> </span><span>241e50a7915c1c9d7e9ddaa9118295fa448168f9aa9cc80b186b58f56122a072</span><span>/</span><span>VERSION</span></p><p><span>x</span><span> </span><span>241e50a7915c1c9d7e9ddaa9118295fa448168f9aa9cc80b186b58f56122a072</span><span>/</span><span>json</span></p><p><span>x</span><span> </span><span>241e50a7915c1c9d7e9ddaa9118295fa448168f9aa9cc80b186b58f56122a072</span><span>/</span><span>layer</span><span>.</span><span>tar</span></p><p><span>x</span><span> </span><span>6c7f27111a8796008108962a65a7ab1e1490de70c34ac31fbafc74930d7d2ad2</span><span>/</span></p><p><span>x</span><span> </span><span>6c7f27111a8796008108962a65a7ab1e1490de70c34ac31fbafc74930d7d2ad2</span><span>/</span><span>VERSION</span></p><p><span>x</span><span> </span><span>6c7f27111a8796008108962a65a7ab1e1490de70c34ac31fbafc74930d7d2ad2</span><span>/</span><span>json</span></p><p><span>x</span><span> </span><span>6c7f27111a8796008108962a65a7ab1e1490de70c34ac31fbafc74930d7d2ad2</span><span>/</span><span>layer</span><span>.</span><span>tar</span></p><p><span>x</span><span> </span><span>73c6c533cd7fa1fa40ee3868779f1a7cc0832f901af9d8ffd4e6215266460745</span><span>/</span></p><p><span>x</span><span> </span><span>73c6c533cd7fa1fa40ee3868779f1a7cc0832f901af9d8ffd4e6215266460745</span><span>/</span><span>VERSION</span></p><p><span>x</span><span> </span><span>73c6c533cd7fa1fa40ee3868779f1a7cc0832f901af9d8ffd4e6215266460745</span><span>/</span><span>json</span></p><p><span>x</span><span> </span><span>73c6c533cd7fa1fa40ee3868779f1a7cc0832f901af9d8ffd4e6215266460745</span><span>/</span><span>layer</span><span>.</span><span>tar</span></p><p><span>x</span><span> </span><span>7ce4f91ef623b9672ec12302c4a710629cd542617c1ebc616a48d06e2a84656a.json</span></p><p><span>x</span><span> </span><span>8d962a933e208a6b2a55a8b69a6335f7a9815fd3ff7478077aef0c2578bb2cbc</span><span>/</span></p><p><span>x</span><span> </span><span>8d962a933e208a6b2a55a8b69a6335f7a9815fd3ff7478077aef0c2578bb2cbc</span><span>/</span><span>VERSION</span></p><p><span>x</span><span> </span><span>8d962a933e208a6b2a55a8b69a6335f7a9815fd3ff7478077aef0c2578bb2cbc</span><span>/</span><span>json</span></p><p><span>x</span><span> </span><span>8d962a933e208a6b2a55a8b69a6335f7a9815fd3ff7478077aef0c2578bb2cbc</span><span>/</span><span>layer</span><span>.</span><span>tar</span></p><p><span>x</span><span> </span><span>933cc7830332e0910e8d3db6038896713a27a5af0125b7b5aa311477e6fcd869</span><span>/</span></p><p><span>x</span><span> </span><span>933cc7830332e0910e8d3db6038896713a27a5af0125b7b5aa311477e6fcd869</span><span>/</span><span>VERSION</span></p><p><span>x</span><span> </span><span>933cc7830332e0910e8d3db6038896713a27a5af0125b7b5aa311477e6fcd869</span><span>/</span><span>json</span></p><p><span>x</span><span> </span><span>933cc7830332e0910e8d3db6038896713a27a5af0125b7b5aa311477e6fcd869</span><span>/</span><span>layer</span><span>.</span><span>tar</span></p><p><span>x</span><span> </span><span>fa03658ad40153748b0abbe573db2aaf943049a0749d192a4cfa56f107a80270</span><span>/</span></p><p><span>x</span><span> </span><span>fa03658ad40153748b0abbe573db2aaf943049a0749d192a4cfa56f107a80270</span><span>/</span><span>VERSION</span></p><p><span>x</span><span> </span><span>fa03658ad40153748b0abbe573db2aaf943049a0749d192a4cfa56f107a80270</span><span>/</span><span>json</span></p><p><span>x</span><span> </span><span>fa03658ad40153748b0abbe573db2aaf943049a0749d192a4cfa56f107a80270</span><span>/</span><span>layer</span><span>.</span><span>tar</span></p><p><span>x</span><span> </span><span>manifest</span><span>.</span><span>json</span></p><p><span>x</span><span> </span><span>repositories</span></p></div></td></tr></tbody></table>

然后使用 tree 命令看下里面的结构：

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p></div></td><td><div><p><span>$</span><span> </span><span>tree</span></p><p><span>.</span></p><p>├──<span> </span><span>241e50a7915c1c9d7e9ddaa9118295fa448168f9aa9cc80b186b58f56122a072</span></p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span><span>VERSION</span></p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span><span>json</span></p><p>│&nbsp;&nbsp;<span> </span>└──<span> </span><span>layer</span><span>.</span><span>tar</span></p><p>├──<span> </span><span>6c7f27111a8796008108962a65a7ab1e1490de70c34ac31fbafc74930d7d2ad2</span></p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span><span>VERSION</span></p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span><span>json</span></p><p>│&nbsp;&nbsp;<span> </span>└──<span> </span><span>layer</span><span>.</span><span>tar</span></p><p>├──<span> </span><span>73c6c533cd7fa1fa40ee3868779f1a7cc0832f901af9d8ffd4e6215266460745</span></p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span><span>VERSION</span></p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span><span>json</span></p><p>│&nbsp;&nbsp;<span> </span>└──<span> </span><span>layer</span><span>.</span><span>tar</span></p><p>├──<span> </span><span>7ce4f91ef623b9672ec12302c4a710629cd542617c1ebc616a48d06e2a84656a.json</span></p><p>├──<span> </span><span>8d962a933e208a6b2a55a8b69a6335f7a9815fd3ff7478077aef0c2578bb2cbc</span></p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span><span>VERSION</span></p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span><span>json</span></p><p>│&nbsp;&nbsp;<span> </span>└──<span> </span><span>layer</span><span>.</span><span>tar</span></p><p>├──<span> </span><span>933cc7830332e0910e8d3db6038896713a27a5af0125b7b5aa311477e6fcd869</span></p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span><span>VERSION</span></p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span><span>json</span></p><p>│&nbsp;&nbsp;<span> </span>└──<span> </span><span>layer</span><span>.</span><span>tar</span></p><p>├──<span> </span><span>fa03658ad40153748b0abbe573db2aaf943049a0749d192a4cfa56f107a80270</span></p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span><span>VERSION</span></p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span><span>json</span></p><p>│&nbsp;&nbsp;<span> </span>└──<span> </span><span>layer</span><span>.</span><span>tar</span></p><p>├──<span> </span><span>manifest</span><span>.</span><span>json</span></p><p>└──<span> </span><span>repositories</span></p></div></td></tr></tbody></table>

打开 `manifest.json` 就会发现里面标注了 config 文件，以及 layers 的信息，config 里面有每一层 layer 的信息。

如果解压 `layer.tar`，就可以看到里面用于构建 rootfs 的一些文件了。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>tar </span><span>xvf</span><span> </span><span>8d962a933e208a6b2a55a8b69a6335f7a9815fd3ff7478077aef0c2578bb2cbc</span><span>/</span><span>layer</span><span>.</span><span>tar</span></p><p><span>x</span><span> </span><span>docker</span><span>-</span><span>entrypoint</span><span>.</span><span>d</span><span>/</span></p><p><span>x</span><span> </span><span>docker</span><span>-</span><span>entrypoint</span><span>.</span><span>d</span><span>/</span><span>.</span><span>wh</span><span>.</span><span>.</span><span>wh</span><span>.</span><span>.</span><span>opq</span></p><p><span>x</span><span> </span><span>etc</span><span>/</span></p><p><span>x</span><span> </span><span>etc</span><span>/</span><span>.</span><span>pwd</span><span>.</span><span>lock</span></p><p><span>x</span><span> </span><span>etc</span><span>/</span><span>apt</span><span>/</span></p><p><span>x</span><span> </span><span>etc</span><span>/</span><span>apt</span><span>/</span><span>sources</span><span>.</span><span>list</span><span>.</span><span>d</span><span>/</span></p><p><span>x</span><span> </span><span>etc</span><span>/</span><span>apt</span><span>/</span><span>trusted</span><span>.</span><span>gpg</span></p><p><span>x</span><span> </span><span>etc</span><span>/</span><span>ca</span><span>-</span><span>certificates</span><span>/</span></p><p><span>x</span><span> </span><span>etc</span><span>/</span><span>ca</span><span>-</span><span>certificates</span><span>/</span><span>.</span><span>wh</span><span>.</span><span>.</span><span>wh</span><span>.</span><span>.</span><span>opq</span></p><p><span>x</span><span> </span><span>etc</span><span>/</span><span>ca</span><span>-</span><span>certificates</span><span>/</span><span>update</span><span>.</span><span>d</span><span>/</span></p><p><span>x</span><span> </span><span>etc</span><span>/</span><span>ca</span><span>-</span><span>certificates</span><span>.</span><span>conf</span></p><p><span>.</span><span>.</span><span>.</span></p></div></td></tr></tbody></table>

容器运行的时候，就依赖这些文件，而不依赖 host 系统上的依赖。这样就做到和 host 上面的依赖隔离。

### Runtime Spec

从 Image 解包之后，我们就可以创建 container 了，大体的过程就是创建一个 container 然后在 container 中运行进程。因为有了 Image 里面的依赖，容器里面就可以不依赖系统的任何依赖。

容器的生命周期如下：

[![](https://www.kawabangga.com/wp-content/uploads/2021/04/Canvas-4-300x105.png)](https://www.kawabangga.com/wp-content/uploads/2021/04/Canvas-4.png)

### Image, Container 和 Process

1.  Containers 从 Image 创建，一个 Image 可以创建多个 contaners
2.  但是在 Container 作出修改之后，也可以直接将里面的内容保存为新的 Image
3.  进程运行在 Container 里面

### 实现和生态

[runC](https://github.com/opencontainers/runc) 是 OCI 的标准实现。Docker 是在之上包装了 daemon 和 cli。

[![](https://www.kawabangga.com/wp-content/uploads/2021/04/OCI.png)](https://www.kawabangga.com/wp-content/uploads/2021/04/OCI.png)

Kubernetes 为了实现可替换的容器运行时实现，定义了 CRI ([Container Runtime Interface](https://kubernetes.io/blog/2016/12/container-runtime-interface-cri-in-kubernetes/))，现在的实现有 `cri-containerd` 和 `cri-o` 等，但是都是基于 `oci/runc` 的。

[![](https://www.kawabangga.com/wp-content/uploads/2021/04/CRI-1024x627.png)](https://www.kawabangga.com/wp-content/uploads/2021/04/CRI.png)

所以后文中使用 runc 来解释容器用到的一些技术。

## 2\. 进程之间的隔离

如果没有 namepsace 的话，就不会有 docker 了。在容器里面，一个进程只能看到同一个容器下面的其他进程(pid)，就是用 namespace 实现的。

namespace 有很多种，比如 pid namespace, mount namespace。先来通过例子说 pid namespace。

## 运行 runc

要运行一个 runc 的容器，首先需要一个符合 OCI Spec 的 bundle。我们可以直接通过 docker 创建这样的一个 bundle。

首先我们创建一个目录来运行我们的 runc，在里面需要创建一个 rootfs 目录。然后用 docker 下载一个 busybox 的 image 输出到 rootfs 中。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span># create the top most bundle directory</span></p><p><span>$</span><span> </span><span>mkdir</span><span> </span><span>/</span><span>mycontainer</span></p><p><span>$</span><span> </span><span>cd</span><span> </span><span>/</span><span>mycontainer</span></p><p><span># create the rootfs directory</span></p><p><span>$</span><span> </span><span>mkdir </span><span>rootfs</span></p><p><span># export busybox via Docker into the rootfs directory</span></p><p><span>$</span><span> </span><span>docker </span><span>export</span><span> </span><span>$</span><span>(</span><span>docker </span><span>create </span><span>busybox</span><span>)</span><span> </span><span>|</span><span> </span><span>tar</span><span> </span><span>-</span><span>C</span><span> </span><span>rootfs</span><span> </span><span>-</span><span>xvf</span><span> </span><span>-</span></p></div></td></tr></tbody></table>

然后运行 `runc spec` ，这个命令会创建一个 `config.json` 作为默认的配置文件。

进入到 containers 文件夹，就可以运行 runc 了（需要 root 权限）。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span># run as root</span></p><p><span>cd</span><span> </span><span>/</span><span>mycontainer</span></p><p><span>runc </span><span>run </span><span>mycontainerid</span></p></div></td></tr></tbody></table>

### 查看 namespace

容器只是在 host 机器上的一个普通进程而已。我们可以通过 [perf-tools](https://github.com/brendangregg/perf-tools) 里面的 execsnoop 来查看容器进程在 host 上面的 pid。execsnoop 顾名思义，可以 snoop Linux 的 exec 调用。在虚拟机里面可能不工作，最好找一台物理机（或者笔记本）进行试验。

我们退出刚才的 runc 容器，先打开 execsnoop，然后在另一个窗口中在开启容器。会发现 host 上有了新的进程。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span></span><span>92518</span><span>&nbsp;&nbsp;</span><span>90576</span><span> </span><span>runc </span><span>run </span><span>xyxy</span></p><p><span></span><span>92524</span><span>&nbsp;&nbsp;</span><span>92521</span><span> </span><span>runc </span><span>init</span></p><p><span></span><span>92528</span><span>&nbsp;&nbsp;</span><span>92527</span><span> </span><span>sh</span></p></div></td></tr></tbody></table>

新的进程的 pid 是 92528.

可以使用 ps 程序查看这个 pid 的 pid namespace.

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>ps</span><span> </span><span>-</span><span>p</span><span> </span><span>92528</span><span> </span><span>-</span><span>o</span><span> </span><span>pid</span><span>,</span><span>pidns</span></p><p><span>&nbsp;&nbsp; </span><span>PID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>PIDNS</span></p><p><span></span><span>92528</span><span> </span><span>4026534092</span></p></div></td></tr></tbody></table>

可以看到在宿主机这个进程的 pidns 是 4026534092。

这个命令只显示了 pid namespace, 我们可以通过 `/proc` 文件系统查看这个进程其他的 pidns.

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>ls</span><span> </span><span>-</span><span>l</span><span> </span><span>/</span><span>proc</span><span>/</span><span>92528</span><span>/</span><span>ns</span></p><p><span>total</span><span> </span><span>0</span></p><p><span>lrwxrwxrwx</span><span> </span><span>1</span><span> </span><span>root </span><span>root</span><span> </span><span>0</span><span> </span><span>Apr</span><span>&nbsp;&nbsp;</span><span>4</span><span> </span><span>23</span><span>:</span><span>41</span><span> </span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span> </span><span>-&gt;</span><span> </span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span>:</span><span>[</span><span>4026531835</span><span>]</span></p><p><span>lrwxrwxrwx</span><span> </span><span>1</span><span> </span><span>root </span><span>root</span><span> </span><span>0</span><span> </span><span>Apr</span><span>&nbsp;&nbsp;</span><span>4</span><span> </span><span>23</span><span>:</span><span>28</span><span> </span><span>ipc</span><span> </span><span>-&gt;</span><span> </span><span>ipc</span><span>:</span><span>[</span><span>4026534091</span><span>]</span></p><p><span>lrwxrwxrwx</span><span> </span><span>1</span><span> </span><span>root </span><span>root</span><span> </span><span>0</span><span> </span><span>Apr</span><span>&nbsp;&nbsp;</span><span>4</span><span> </span><span>23</span><span>:</span><span>28</span><span> </span><span>mnt</span><span> </span><span>-&gt;</span><span> </span><span>mnt</span><span>:</span><span>[</span><span>4026534089</span><span>]</span></p><p><span>lrwxrwxrwx</span><span> </span><span>1</span><span> </span><span>root </span><span>root</span><span> </span><span>0</span><span> </span><span>Apr</span><span>&nbsp;&nbsp;</span><span>4</span><span> </span><span>23</span><span>:</span><span>27</span><span> </span><span>net</span><span> </span><span>-&gt;</span><span> </span><span>net</span><span>:</span><span>[</span><span>4026534094</span><span>]</span></p><p><span>lrwxrwxrwx</span><span> </span><span>1</span><span> </span><span>root </span><span>root</span><span> </span><span>0</span><span> </span><span>Apr</span><span>&nbsp;&nbsp;</span><span>4</span><span> </span><span>23</span><span>:</span><span>28</span><span> </span><span>pid</span><span> </span><span>-&gt;</span><span> </span><span>pid</span><span>:</span><span>[</span><span>4026534092</span><span>]</span></p><p><span>lrwxrwxrwx</span><span> </span><span>1</span><span> </span><span>root </span><span>root</span><span> </span><span>0</span><span> </span><span>Apr</span><span>&nbsp;&nbsp;</span><span>4</span><span> </span><span>23</span><span>:</span><span>41</span><span> </span><span>pid_for_children</span><span> </span><span>-&gt;</span><span> </span><span>pid</span><span>:</span><span>[</span><span>4026534092</span><span>]</span></p><p><span>lrwxrwxrwx</span><span> </span><span>1</span><span> </span><span>root </span><span>root</span><span> </span><span>0</span><span> </span><span>Apr</span><span>&nbsp;&nbsp;</span><span>4</span><span> </span><span>23</span><span>:</span><span>28</span><span> </span><span>user</span><span> </span><span>-&gt;</span><span> </span><span>user</span><span>:</span><span>[</span><span>4026531837</span><span>]</span></p><p><span>lrwxrwxrwx</span><span> </span><span>1</span><span> </span><span>root </span><span>root</span><span> </span><span>0</span><span> </span><span>Apr</span><span>&nbsp;&nbsp;</span><span>4</span><span> </span><span>23</span><span>:</span><span>28</span><span> </span><span>uts</span><span> </span><span>-&gt;</span><span> </span><span>uts</span><span>:</span><span>[</span><span>4026534090</span><span>]</span></p></div></td></tr></tbody></table>

使用 [cinf](https://github.com/mhausenblas/cinf) 工具，可以查看这个 namespace 更详细的内容。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>cinf</span><span> </span><span>-</span><span>namespace</span><span> </span><span>4026534092</span></p><p><span></span><span>PID&nbsp;&nbsp;&nbsp;&nbsp;</span><span>PPID&nbsp;&nbsp; </span><span>NAME&nbsp;&nbsp;</span><span>CMD</span><span>&nbsp;&nbsp;</span><span>NTHREADS</span><span>&nbsp;&nbsp;</span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span>S</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>STATE</span></p><p><span></span><span>92528</span><span>&nbsp;&nbsp;</span><span>92518</span><span>&nbsp;&nbsp;</span><span>sh&nbsp;&nbsp;&nbsp;&nbsp;</span><span>sh</span><span>&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>12</span><span>:</span><span>perf_event</span><span>:</span><span>/</span><span>xyxy</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>S</span><span> </span><span>(</span><span>sleeping</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>11</span><span>:</span><span>memory</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>10</span><span>:</span><span>hugetlb</span><span>:</span><span>/</span><span>xyxy</span><span> </span><span>9</span><span>:</span><span>rdma</span><span>:</span><span>/</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>8</span><span>:</span><span>devices</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>7</span><span>:</span><span>freezer</span><span>:</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>6</span><span>:</span><span>cpu</span><span>,</span><span>cpuacct</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>5</span><span>:</span><span>blkio</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>4</span><span>:</span><span>cpuset</span><span>:</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>3</span><span>:</span><span>pids</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span>:</span><span>net_cls</span><span>,</span><span>net_prio</span><span>:</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>1</span><span>:</span><span>name</span><span>=</span><span>systemd</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span>::</span><span>/</span></p></div></td></tr></tbody></table>

可以看到这个 ns 下面只有一个进程。

到这里可以得出结论，当我们启动一个新的容器的时候，一系列的 namespace 会自动创建，init 进程会被放到这个 namespace 下面：

-   一个级才能拿只能看到同一个 namespace 下面的其他进程
-   在容器里面 pid=1 的进程，在 host 上只是一个普通进程

## docker/runc exec

那么当我们执行 exec 的时候发生了什么呢？

运行 `runc exec xyxy /bin/top -b` ，从 execsnoop 中可以看到 pid：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>107185</span><span> </span><span>107046</span><span> </span><span>runc </span><span>exec</span><span> </span><span>xyxy</span><span> </span><span>/</span><span>bin</span><span>/</span><span>top</span><span> </span><span>-</span><span>b</span></p><p><span>107192</span><span> </span><span>107191</span><span> </span><span>runc </span><span>init</span></p><p><span>107195</span><span> </span><span>107194</span><span> </span><span>/</span><span>bin</span><span>/</span><span>top</span><span> </span><span>-</span><span>b</span></p></div></td></tr></tbody></table>

直接使用 runc 的 ps 命令也可以看到 pid，但是 pid 会和 execsnoop 显示的命令不一样：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>runc </span><span>ps </span><span>xyxy</span></p><p><span>UID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>PID&nbsp;&nbsp; </span><span>PPID</span><span>&nbsp;&nbsp;</span><span>C</span><span> </span><span>STIME </span><span>TTY</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>TIME</span><span> </span><span>CMD</span></p><p><span>root</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>92528</span><span>&nbsp;&nbsp;</span><span>92518</span><span>&nbsp;&nbsp;</span><span>0</span><span> </span><span>Apr04 </span><span>pts</span><span>/</span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span><span> </span><span>sh</span></p><p><span>root</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>107625</span><span> </span><span>107616</span><span>&nbsp;&nbsp;</span><span>0</span><span> </span><span>00</span><span>:</span><span>03</span><span> </span><span>pts</span><span>/</span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span><span> </span><span>/</span><span>bin</span><span>/</span><span>top</span><span> </span><span>-</span><span>b</span></p></div></td></tr></tbody></table>

在运行原来的 `cinf` 命令查看这个 namespace:

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p></div></td><td><div><p><span>$</span><span> </span><span>cinf</span><span> </span><span>-</span><span>namespace</span><span> </span><span>4026534092</span></p><p><span></span><span>PID&nbsp;&nbsp;&nbsp;&nbsp; </span><span>PPID&nbsp;&nbsp;&nbsp;&nbsp;</span><span>NAME&nbsp;&nbsp;</span><span>CMD</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>NTHREADS</span><span>&nbsp;&nbsp;</span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span>S</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>STATE</span></p><p><span></span><span>107625</span><span>&nbsp;&nbsp;</span><span>107616</span><span>&nbsp;&nbsp;</span><span>top</span><span>&nbsp;&nbsp; </span><span>/</span><span>bin</span><span>/</span><span>top</span><span> </span><span>-</span><span>b</span><span>&nbsp;&nbsp;</span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>12</span><span>:</span><span>perf_event</span><span>:</span><span>/</span><span>xyxy</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>S</span><span> </span><span>(</span><span>sleeping</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>11</span><span>:</span><span>memory</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>10</span><span>:</span><span>hugetlb</span><span>:</span><span>/</span><span>xyxy</span><span> </span><span>9</span><span>:</span><span>rdma</span><span>:</span><span>/</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>8</span><span>:</span><span>devices</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>7</span><span>:</span><span>freezer</span><span>:</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>6</span><span>:</span><span>cpu</span><span>,</span><span>cpuacct</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>5</span><span>:</span><span>blkio</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>4</span><span>:</span><span>cpuset</span><span>:</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>3</span><span>:</span><span>pids</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span>:</span><span>net_cls</span><span>,</span><span>net_prio</span><span>:</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>1</span><span>:</span><span>name</span><span>=</span><span>systemd</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span>::</span><span>/</span></p><p><span></span><span>92528</span><span>&nbsp;&nbsp; </span><span>92518</span><span>&nbsp;&nbsp; </span><span>sh&nbsp;&nbsp;&nbsp;&nbsp;</span><span>sh</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>12</span><span>:</span><span>perf_event</span><span>:</span><span>/</span><span>xyxy</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>S</span><span> </span><span>(</span><span>sleeping</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>11</span><span>:</span><span>memory</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>10</span><span>:</span><span>hugetlb</span><span>:</span><span>/</span><span>xyxy</span><span> </span><span>9</span><span>:</span><span>rdma</span><span>:</span><span>/</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>8</span><span>:</span><span>devices</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>7</span><span>:</span><span>freezer</span><span>:</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>6</span><span>:</span><span>cpu</span><span>,</span><span>cpuacct</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>5</span><span>:</span><span>blkio</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>4</span><span>:</span><span>cpuset</span><span>:</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>3</span><span>:</span><span>pids</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span>:</span><span>net_cls</span><span>,</span><span>net_prio</span><span>:</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>1</span><span>:</span><span>name</span><span>=</span><span>systemd</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c7</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span>::</span><span>/</span></p></div></td></tr></tbody></table>

可以看到现在这个 namespace 下面有两个进程了。

在 runc 的容器里面我们去看 top，会发现有两个进程，它们的 pid 分别是 1 和 13，这就是 namespace 的作用。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>Mem</span><span>:</span><span> </span><span>8779872K</span><span> </span><span>used</span><span>,</span><span> </span><span>518678628K</span><span> </span><span>free</span><span>,</span><span> </span><span>3682912K</span><span> </span><span>shrd</span><span>,</span><span> </span><span>175384K</span><span> </span><span>buff</span><span>,</span><span> </span><span>6101996K</span><span> </span><span>cached</span></p><p><span>CPU</span><span>:</span><span>&nbsp;&nbsp;</span><span>0.0</span><span>%</span><span> </span><span>usr</span><span>&nbsp;&nbsp;</span><span>0.0</span><span>%</span><span> </span><span>sys</span><span>&nbsp;&nbsp;</span><span>0.0</span><span>%</span><span> </span><span>nic</span><span> </span><span>99.9</span><span>%</span><span> </span><span>idle</span><span>&nbsp;&nbsp;</span><span>0.0</span><span>%</span><span> </span><span>io</span><span>&nbsp;&nbsp;</span><span>0.0</span><span>%</span><span> </span><span>irq</span><span>&nbsp;&nbsp;</span><span>0.0</span><span>%</span><span> </span><span>sirq</span></p><p><span>Load </span><span>average</span><span>:</span><span> </span><span>4.32</span><span> </span><span>3.79</span><span> </span><span>3.78</span><span> </span><span>2</span><span>/</span><span>1783</span><span> </span><span>18</span></p><p><span>&nbsp;&nbsp;</span><span>PID&nbsp;&nbsp;</span><span>PPID </span><span>USER</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>STAT</span><span>&nbsp;&nbsp; </span><span>VSZ</span><span> </span><span>%</span><span>VSZ </span><span>CPU</span><span> </span><span>%</span><span>CPU </span><span>COMMAND</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span> </span><span>root</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>S</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>1320</span><span>&nbsp;&nbsp;</span><span>0.0</span><span>&nbsp;&nbsp;</span><span>46</span><span>&nbsp;&nbsp;</span><span>0.0</span><span> </span><span>sh</span></p><p><span>&nbsp;&nbsp; </span><span>13</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span> </span><span>root</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>R</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>1316</span><span>&nbsp;&nbsp;</span><span>0.0</span><span>&nbsp;&nbsp;</span><span>30</span><span>&nbsp;&nbsp;</span><span>0.0</span><span> </span><span>/</span><span>bin</span><span>/</span><span>top</span><span> </span><span>-</span><span>b</span></p></div></td></tr></tbody></table>

## 3\. cgroups

Namespaces 可以控制进程在 container 中可以看到什么（隔离），而 cgroups 可以控制进程可以使用的资源（资源）。

我们可以使用 `lscgroup` 查看现在系统上的 cgroup, 然后将它保存到一个文件中

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>lscgroup</span><span> </span><span>|</span><span> </span><span>tee </span><span>cgroup</span><span>.</span><span>b</span></p></div></td></tr></tbody></table>

然后使用 `runc run xyxy` 启动一个名字叫 `xyxy` 的容器，再次查看 cgroup：

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p></div></td><td><div><p><span>$</span><span> </span><span>lscgroup</span><span> </span><span>|</span><span> </span><span>tee </span><span>cgroup</span><span>.</span><span>a</span></p><p><span>$</span><span> </span><span>diff </span><span>cgroup</span><span>.</span><span>b</span><span> </span><span>cgroup</span><span>.</span><span>a</span></p><p><span>4a5</span></p><p><span>&gt;</span><span> </span><span>net_cls</span><span>,</span><span>net_prio</span><span>:</span><span>/</span><span>xyxy</span></p><p><span>12a14</span></p><p><span>&gt;</span><span> </span><span>pids</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>121a124</span></p><p><span>&gt;</span><span> </span><span>cpuset</span><span>:</span><span>/</span><span>xyxy</span></p><p><span>129a133</span></p><p><span>&gt;</span><span> </span><span>blkio</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>242a247</span></p><p><span>&gt;</span><span> </span><span>cpu</span><span>,</span><span>cpuacct</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>352a358</span></p><p><span>&gt;</span><span> </span><span>freezer</span><span>:</span><span>/</span><span>xyxy</span></p><p><span>360a367</span></p><p><span>&gt;</span><span> </span><span>devices</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>470a478</span></p><p><span>&gt;</span><span> </span><span>hugetlb</span><span>:</span><span>/</span><span>xyxy</span></p><p><span>478a487</span></p><p><span>&gt;</span><span> </span><span>memory</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span></p><p><span>588a598</span></p><p><span>&gt;</span><span> </span><span>perf_event</span><span>:</span><span>/</span><span>xyxy</span></p></div></td></tr></tbody></table>

可以看到容器创建之后系统上多了一些 cgroup，并且它们的 parent 目录是我们的 sh 所在的 cgroup.

cgroup 可以控制进程所能使用的内存，cpu 等资源。

在容器的 cgroup 中也可以加入更多的进程。

首先使用 runc 查看一下进程的 pid：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>runc </span><span>ps </span><span>xyxy</span></p><p><span>UID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>PID&nbsp;&nbsp; </span><span>PPID</span><span>&nbsp;&nbsp;</span><span>C</span><span> </span><span>STIME </span><span>TTY</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>TIME</span><span> </span><span>CMD</span></p><p><span>root</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>713</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>703</span><span>&nbsp;&nbsp;</span><span>0</span><span> </span><span>15</span><span>:</span><span>40</span><span> </span><span>?</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span><span> </span><span>sh</span></p></div></td></tr></tbody></table>

然后查看这个 cgroup 下面有哪些进程：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>cat</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>memory</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>tasks</span></p><p><span>713</span></p></div></td></tr></tbody></table>

发现只有这一个。

下面通过容器的 exec 命令加入一个新的进程到这个 cgroup 中：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>runc </span><span>exec</span><span> </span><span>xyxy</span><span> </span><span>/</span><span>bin</span><span>/</span><span>top</span><span> </span><span>-</span><span>b</span></p></div></td></tr></tbody></table>

然后再次查看是否有新的 cgroup 生成：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>lscgroup</span><span> </span><span>|</span><span> </span><span>tee </span><span>cgroup</span><span>.</span><span>c</span></p><p><span>$</span><span> </span><span>diff </span><span>cgroup</span><span>.</span><span>a</span><span> </span><span>cgroup</span><span>.</span><span>c</span></p></div></td></tr></tbody></table>

输出为空，说明没有新的 cgroup 生成。

然后通过查看原来的 cgroup，可以确认新的进程 top 被加入到了原来的 cgroup 中。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>cat</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>memory</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>tasks</span></p><p><span>713</span></p><p><span>5126</span></p></div></td></tr></tbody></table>

总结：当一个新的 container 创建的时候，容器会为每种资源创建一个 cgroup 来限制容器可以使用的资源。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>ls</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span>/</span><span>*</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>tasks</span></p><p><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span>/</span><span>blkio</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>tasks</span></p><p><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span>/</span><span>cpu</span><span>,</span><span>cpuacct</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>tasks</span></p><p><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span>/</span><span>cpu</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>tasks</span></p><p><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span>/</span><span>cpuacct</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>tasks</span></p><p><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span>/</span><span>devices</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>tasks</span></p><p><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span>/</span><span>memory</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>tasks</span></p><p><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span>/</span><span>pids</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>tasks</span></p><p><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span>/</span><span>systemd</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>tasks</span></p></div></td></tr></tbody></table>

那么如何通过 cgroup 来对资源限制呢？

默认情况下的容器是不限制资源的，比如说内存，默认情况下是 9223372036854771712：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>cat</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>memory</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>memory</span><span>.</span><span>limit_in</span><span>_</span>bytes</p><p><span>9223372036854771712</span></p></div></td></tr></tbody></table>

要限制一个容器使用的内存大小，只需要将限制写入到这个文件里面去就可以了：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>echo</span><span> </span><span>100000000</span><span> </span><span>&gt;</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>memory</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>memory</span><span>.</span><span>limit_in_bytes</span></p></div></td></tr></tbody></table>

内存是一个非弹性的资源，不像是 CPU 和 IO，如果资源压力很大，程序不会直接退出，可能会运行慢一些，然后再资源缓解的时候恢复。对于内存来说，如果程序无法申请出来需要的内存的话，就会直接退出（或者 pause，取决于 `memory.oom_control` 的设置）。

上面这种修改 cgroup 限制的方法，其实就是 runc 在做的事情。但是使用 runc 我们不应该直接去改 cgroup，而是应该修改 `config.json` ，然后 runc 帮我们去配置 cgroup。

修改方法是在 `linux.resources` 下面添加：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>"memory"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"limit"</span><span>:</span><span> </span><span>100000000</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"reservation"</span><span>:</span><span> </span><span>200000</span></p><p><span>}</span></p></div></td></tr></tbody></table>

然后 runc 启动之后可以查看 cgroup 限制。

我们可以验证 runc 的资源限制是通过 cgroup 来实现的，通过修改内存限制到一个很小的值（比如10000）让容器无法启动而报错：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>runc </span><span>run </span><span>xyxy</span></p><p><span>container_linux</span><span>.</span><span>go</span><span>:</span><span>475</span><span>:</span><span> </span><span>starting </span><span>container </span><span>process </span><span>caused</span><span> </span><span>"process_linux.go:434: container init caused \"process_linux.go:400: setting [[cgroup]] config for procHooks process caused \\\"</span><span>failed </span><span>to </span><span>write</span><span> </span><span>1000000</span><span> </span><span>to </span><span>memory</span><span>.</span><span>limit_in_bytes</span><span>:</span><span> </span><span>write</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>[</span><span>[</span><span>cgroup</span><span>]</span><span>]</span><span>/</span><span>memory</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>0.slice</span><span>/</span><span>session</span><span>-</span><span>c9</span><span>.</span><span>scope</span><span>/</span><span>xyxy</span><span>/</span><span>memory</span><span>.</span><span>limit_in_bytes</span><span>:</span><span> </span><span>device</span><span> </span><span>or</span><span> </span><span>resource</span><span> </span><span>busy</span><span>\</span><span>\</span><span>\</span><span>"\""</span></p></div></td></tr></tbody></table>

从错误日志可以看到，cgroup 的限制文件无法写入。可以确认底层就是 cgroup.

## 4\. Linux Capabilities

[Capabilities](https://man7.org/linux/man-pages/man7/capabilities.7.html) 也是 Linux 提供的功能，可以在用户有 root 权限的同时，限制 root 使用某些权限。

先准备好一个容器，带有 Libcap，这里我们还是直接使用 docker 安装好然后导出。

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p></div></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span># docker run -it alpine sh -c 'apk add -U libcap; capsh --print';</span></p><p><span>Unable </span><span>to </span><span>find </span><span>image</span><span> </span><span>'alpine:latest'</span><span> </span><span>locally</span></p><p><span>latest</span><span>:</span><span> </span><span>Pulling </span><span>from</span><span> </span><span>library</span><span>/</span><span>alpine</span></p><p><span>ca3cd42a7c95</span><span>:</span><span> </span><span>Pull </span><span>complete</span></p><p><span>Digest</span><span>:</span><span> </span><span>sha256</span><span>:</span><span>ec14c7992a97fc11425907e908340c6c3d6ff602f5f13d899e6b7027c9b4133a</span></p><p><span>Status</span><span>:</span><span> </span><span>Downloaded </span><span>newer </span><span>image </span><span>for</span><span> </span><span>alpine</span><span>:</span><span>latest</span></p><p><span>fetch </span><span>https</span><span>:</span><span>/</span><span>/</span><span>dl</span><span>-</span><span>cdn</span><span>.</span><span>alpinelinux</span><span>.</span><span>org</span><span>/</span><span>alpine</span><span>/</span><span>v3</span><span>.</span><span>13</span><span>/</span><span>main</span><span>/</span><span>x86_64</span><span>/</span><span>APKINDEX</span><span>.</span><span>tar</span><span>.</span><span>gz</span></p><p><span>fetch </span><span>https</span><span>:</span><span>/</span><span>/</span><span>dl</span><span>-</span><span>cdn</span><span>.</span><span>alpinelinux</span><span>.</span><span>org</span><span>/</span><span>alpine</span><span>/</span><span>v3</span><span>.</span><span>13</span><span>/</span><span>community</span><span>/</span><span>x86_64</span><span>/</span><span>APKINDEX</span><span>.</span><span>tar</span><span>.</span><span>gz</span></p><p><span>(</span><span>1</span><span>/</span><span>1</span><span>)</span><span> </span><span>Installing </span><span>libcap</span><span> </span><span>(</span><span>2.46</span><span>-</span><span>r0</span><span>)</span></p><p><span>Executing </span><span>busybox</span><span>-</span><span>1.32.1</span><span>-</span><span>r5</span><span>.</span><span>trigger</span></p><p><span>OK</span><span>:</span><span> </span><span>6</span><span> </span><span>MiB </span><span>in</span><span> </span><span>15</span><span> </span><span>packages</span></p><p><span>Current</span><span>:</span><span> </span><span>cap_chown</span><span>,</span><span>cap_dac_override</span><span>,</span><span>cap_fowner</span><span>,</span><span>cap_fsetid</span><span>,</span><span>cap_kill</span><span>,</span><span>cap_setgid</span><span>,</span><span>cap_setuid</span><span>,</span><span>cap_setpcap</span><span>,</span><span>cap_net_bind_service</span><span>,</span><span>cap_net_raw</span><span>,</span><span>cap_sys_chroot</span><span>,</span><span>cap_mknod</span><span>,</span><span>cap_audit_write</span><span>,</span><span>cap_setfcap</span><span>=</span><span>eip</span></p><p><span>Bounding </span><span>set</span><span> </span><span>=</span><span>cap_chown</span><span>,</span><span>cap_dac_override</span><span>,</span><span>cap_fowner</span><span>,</span><span>cap_fsetid</span><span>,</span><span>cap_kill</span><span>,</span><span>cap_setgid</span><span>,</span><span>cap_setuid</span><span>,</span><span>cap_setpcap</span><span>,</span><span>cap_net_bind_service</span><span>,</span><span>cap_net_raw</span><span>,</span><span>cap_sys_chroot</span><span>,</span><span>cap_mknod</span><span>,</span><span>cap_audit_write</span><span>,</span><span>cap_setfcap</span></p><p><span>Ambient </span><span>set</span><span> </span><span>=</span></p><p><span>Current </span><span>IAB</span><span>:</span><span> </span><span>cap_chown</span><span>,</span><span>cap_dac_override</span><span>,</span><span>!</span><span>cap_dac_read_search</span><span>,</span><span>cap_fowner</span><span>,</span><span>cap_fsetid</span><span>,</span><span>cap_kill</span><span>,</span><span>cap_setgid</span><span>,</span><span>cap_setuid</span><span>,</span><span>cap_setpcap</span><span>,</span><span>!</span><span>cap_linux_immutable</span><span>,</span><span>cap_net_bind_service</span><span>,</span><span>!</span><span>cap_net_broadcast</span><span>,</span><span>!</span><span>cap_net_admin</span><span>,</span><span>cap_net_raw</span><span>,</span><span>!</span><span>cap_ipc_lock</span><span>,</span><span>!</span><span>cap_ipc_owner</span><span>,</span><span>!</span><span>cap_sys_module</span><span>,</span><span>!</span><span>cap_sys_rawio</span><span>,</span><span>cap_sys_chroot</span><span>,</span><span>!</span><span>cap_sys_ptrace</span><span>,</span><span>!</span><span>cap_sys_pacct</span><span>,</span><span>!</span><span>cap_sys_admin</span><span>,</span><span>!</span><span>cap_sys_boot</span><span>,</span><span>!</span><span>cap_sys_nice</span><span>,</span><span>!</span><span>cap_sys_resource</span><span>,</span><span>!</span><span>cap_sys_time</span><span>,</span><span>!</span><span>cap_sys_tty_config</span><span>,</span><span>cap_mknod</span><span>,</span><span>!</span><span>cap_lease</span><span>,</span><span>cap_audit_write</span><span>,</span><span>!</span><span>cap_audit_control</span><span>,</span><span>cap_setfcap</span><span>,</span><span>!</span><span>cap_mac_override</span><span>,</span><span>!</span><span>cap_mac_admin</span><span>,</span><span>!</span><span>cap_syslog</span><span>,</span><span>!</span><span>cap_wake_alarm</span><span>,</span><span>!</span><span>cap_block_suspend</span><span>,</span><span>!</span><span>cap_audit_read</span></p><p><span>Securebits</span><span>:</span><span> </span><span>00</span><span>/</span><span>0x0</span><span>/</span><span>1</span>'<span>b0</span></p><p><span></span><span>secure</span><span>-</span><span>noroot</span><span>:</span><span> </span><span>no</span><span> </span><span>(</span><span>unlocked</span><span>)</span></p><p><span></span><span>secure</span><span>-</span><span>no</span><span>-</span><span>suid</span><span>-</span><span>fixup</span><span>:</span><span> </span><span>no</span><span> </span><span>(</span><span>unlocked</span><span>)</span></p><p><span></span><span>secure</span><span>-</span><span>keep</span><span>-</span><span>caps</span><span>:</span><span> </span><span>no</span><span> </span><span>(</span><span>unlocked</span><span>)</span></p><p><span></span><span>secure</span><span>-</span><span>no</span><span>-</span><span>ambient</span><span>-</span><span>raise</span><span>:</span><span> </span><span>no</span><span> </span><span>(</span><span>unlocked</span><span>)</span></p><p><span>uid</span><span>=</span><span>0</span><span>(</span><span>root</span><span>)</span><span> </span><span>euid</span><span>=</span><span>0</span><span>(</span><span>root</span><span>)</span></p><p><span>gid</span><span>=</span><span>0</span><span>(</span><span>root</span><span>)</span></p><p><span>groups</span><span>=</span><span>0</span><span>(</span><span>root</span><span>)</span><span>,</span><span>1</span><span>(</span><span>bin</span><span>)</span><span>,</span><span>2</span><span>(</span><span>daemon</span><span>)</span><span>,</span><span>3</span><span>(</span><span>sys</span><span>)</span><span>,</span><span>4</span><span>(</span><span>adm</span><span>)</span><span>,</span><span>6</span><span>(</span><span>disk</span><span>)</span><span>,</span><span>10</span><span>(</span><span>wheel</span><span>)</span><span>,</span><span>11</span><span>(</span><span>floppy</span><span>)</span><span>,</span><span>20</span><span>(</span><span>dialout</span><span>)</span><span>,</span><span>26</span><span>(</span><span>tape</span><span>)</span><span>,</span><span>27</span><span>(</span><span>video</span><span>)</span></p><p><span>Guessed </span><span>mode</span><span>:</span><span> </span><span>UNCERTAIN</span><span> </span><span>(</span><span>0</span><span>)</span></p></div></td></tr></tbody></table>

然后将这个 docker 容器导出到 runc 的 rootfs:

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p></div></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span># docker ps</span></p><p><span>CONTAINER </span><span>ID</span><span>&nbsp;&nbsp; </span><span>IMAGE&nbsp;&nbsp;&nbsp;&nbsp; </span><span>COMMAND&nbsp;&nbsp; </span><span>CREATED&nbsp;&nbsp; </span><span>STATUS&nbsp;&nbsp;&nbsp;&nbsp;</span><span>PORTS&nbsp;&nbsp;&nbsp;&nbsp; </span><span>NAMES</span></p><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span># docker ps -a</span></p><p><span>CONTAINER </span><span>ID</span><span>&nbsp;&nbsp; </span><span>IMAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>COMMAND&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>CREATED&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>PORTS&nbsp;&nbsp;&nbsp;&nbsp; </span><span>NAMES</span></p><p><span>5aad51652320</span><span>&nbsp;&nbsp; </span><span>alpine</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"sh -c 'apk add -U l…"</span><span>&nbsp;&nbsp; </span><span>About</span><span> </span><span>a</span><span> </span><span>minute </span><span>ago&nbsp;&nbsp; </span><span>Exited</span><span> </span><span>(</span><span>0</span><span>)</span><span> </span><span>About</span><span> </span><span>a</span><span> </span><span>minute </span><span>ago&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>angry</span><span>_</span>lamarr</p><p><span>9b463bcb9712</span><span>&nbsp;&nbsp; </span><span>busybox</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"sh"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>20</span><span> </span><span>hours </span><span>ago&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>Created&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>lucid</span><span>_</span>yonath</p><p><span>7eced2fbadb0</span><span>&nbsp;&nbsp; </span><span>hello</span><span>-</span><span>world</span><span>&nbsp;&nbsp; </span><span>"/hello"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>20</span><span> </span><span>hours </span><span>ago&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>Exited</span><span> </span><span>(</span><span>0</span><span>)</span><span> </span><span>20</span><span> </span><span>hours </span><span>ago&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>friendly_cori</span></p><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span># docker export 5aad51652320 | tar -C rootfs -xvf -</span></p><p><span>.</span><span>dockerenv</span></p><p><span>bin</span><span>/</span></p><p><span>bin</span><span>/</span><span>arch</span></p><p><span>bin</span><span>/</span><span>ash</span></p><p><span>bin</span><span>/</span><span>base64</span></p><p><span>bin</span><span>/</span><span>bbconfig</span></p><p><span>bin</span><span>/</span><span>busybox</span></p><p><span>bin</span><span>/</span><span>cat</span></p><p><span>.</span><span>.</span><span>.</span></p></div></td></tr></tbody></table>

最后生成一个 spec：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span># mkdir test_cap</span></p><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span># mv rootfs/ test_cap/</span></p><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span># cd test_cap/</span></p><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span>/</span><span>test</span><span>_</span>cap<span># runc spec</span></p><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span>/</span><span>test</span><span>_</span>cap<span># ls</span></p><p><span>config</span><span>.</span><span>json</span><span>&nbsp;&nbsp;</span><span>rootfs</span></p></div></td></tr></tbody></table>

然后进入到容器里面验证，会发现在容器里面无法修改 hostname，即使已经是 root 了也不行：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span>/</span><span>test</span><span>_</span>cap<span># runc run mycap</span></p><p><span>/</span><span> </span><span># id</span></p><p><span>uid</span><span>=</span><span>0</span><span>(</span><span>root</span><span>)</span><span> </span><span>gid</span><span>=</span><span>0</span><span>(</span><span>root</span><span>)</span></p><p><span>/</span><span> </span><span># hostname xintao.local</span></p><p><span>hostname</span><span>:</span><span> </span><span>sethostname</span><span>:</span><span> </span><span>Operation </span><span>not</span><span> </span><span>permitted</span></p></div></td></tr></tbody></table>

这是因为，修改 hostname 需要 `CAP_SYS_ADMIN` 权限，即使是 root 也需要。

我们可以将 `CAP_SYS_ADMIN` 加入到 init 进程的 capabilities 的 `bounding` `permitted` `effective` list 中。

修改 capabilities 为以下内容：

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p></div></td><td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"capabilities"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"bounding"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_AUDIT_WRITE"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_KILL"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_SYS_ADMIN"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_NET_BIND_SERVICE"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"effective"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_AUDIT_WRITE"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_SYS_ADMIN"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_KILL"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_NET_BIND_SERVICE"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"inheritable"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_AUDIT_WRITE"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_KILL"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_NET_BIND_SERVICE"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"permitted"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_AUDIT_WRITE"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_SYS_ADMIN"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_KILL"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_NET_BIND_SERVICE"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ambient"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_AUDIT_WRITE"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_KILL"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_NET_BIND_SERVICE"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p></div></td></tr></tbody></table>

然后重新开启一个容器进去测试，发现就可以修改 hostname 了。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span>/</span><span>test</span><span>_</span>cap<span># runc exec -t mycap sh</span></p><p><span>/</span><span> </span><span># hostname xintao.local</span></p><p><span>/</span><span> </span><span># hostname</span></p><p><span>xintao</span><span>.</span><span>local</span></p></div></td></tr></tbody></table>

### 查看 Capability

要使用 `pscap` ，首先要安装 `libcap-ng-utils`，然后可以查看刚刚打开的那两个容器的 capabilities:

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span># pscap | grep -E "13076|13177"</span></p><p><span>13065</span><span> </span><span>13076</span><span> </span><span>root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>sh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>kill</span><span>,</span><span> </span><span>net_bind_service</span><span>,</span><span> </span><span>audit</span><span>_</span>write</p><p><span>13168</span><span> </span><span>13177</span><span> </span><span>root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>sh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>kill</span><span>,</span><span> </span><span>net_bind_service</span><span>,</span><span> </span><span>sys_admin</span><span>,</span><span> </span><span>audit_write</span></p></div></td></tr></tbody></table>

可以看到一个有 `sys_admin` ，一个没有。

除了修改 `config.json` 来添加 capabilities，也可以在 exec 的时候直接通过命令行参数 `--cap` 来要求 additional caps.

<table><tbody><tr><td data-settings="show"></td><td><div><p><span># runc exec --cap CAP_SYS_ADMIN xyxyx /bin/hostname cool</span></p></div></td></tr></tbody></table>

在容器中，可以通过 `capsh` 命令查看 capability:

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>/</span><span> </span><span># capsh --print</span></p><p><span>Current</span><span>:</span><span> </span><span>cap_kill</span><span>,</span><span>cap_net_bind_service</span><span>,</span><span>cap_audit_write</span><span>=</span><span>eip </span><span>cap_sys_admin</span><span>+</span><span>ep</span></p><p><span>Bounding </span><span>set</span><span> </span><span>=</span><span>cap_kill</span><span>,</span><span>cap_net_bind_service</span><span>,</span><span>cap_sys_admin</span><span>,</span><span>cap_audit_write</span></p><p><span>Ambient </span><span>set</span><span> </span><span>=</span><span>cap_kill</span><span>,</span><span>cap_net_bind_service</span><span>,</span><span>cap_audit_write</span></p><p><span>Current </span><span>IAB</span><span>:</span><span> </span><span>!</span><span>cap_chown</span><span>,</span><span>!</span><span>cap_dac_override</span><span>,</span><span>!</span><span>cap_dac_read_search</span><span>,</span><span>!</span><span>cap_fowner</span><span>,</span><span>!</span><span>cap_fsetid</span><span>,</span><span>^</span><span>cap_kill</span><span>,</span><span>!</span><span>cap_setgid</span><span>,</span><span>!</span><span>cap_setuid</span><span>,</span><span>!</span><span>cap_setpcap</span><span>,</span><span>!</span><span>cap_linux_immutable</span><span>,</span><span>^</span><span>cap_net_bind_service</span><span>,</span><span>!</span><span>cap_net_broadcast</span><span>,</span><span>!</span><span>cap_net_admin</span><span>,</span><span>!</span><span>cap_net_raw</span><span>,</span><span>!</span><span>cap_ipc_lock</span><span>,</span><span>!</span><span>cap_ipc_owner</span><span>,</span><span>!</span><span>cap_sys_module</span><span>,</span><span>!</span><span>cap_sys_rawio</span><span>,</span><span>!</span><span>cap_sys_chroot</span><span>,</span><span>!</span><span>cap_sys_ptrace</span><span>,</span><span>!</span><span>cap_sys_pacct</span><span>,</span><span>!</span><span>cap_sys_boot</span><span>,</span><span>!</span><span>cap_sys_nice</span><span>,</span><span>!</span><span>cap_sys_resource</span><span>,</span><span>!</span><span>cap_sys_time</span><span>,</span><span>!</span><span>cap_sys_tty_config</span><span>,</span><span>!</span><span>cap_mknod</span><span>,</span><span>!</span><span>cap_lease</span><span>,</span><span>^</span><span>cap_audit_write</span><span>,</span><span>!</span><span>cap_audit_control</span><span>,</span><span>!</span><span>cap_setfcap</span><span>,</span><span>!</span><span>cap_mac_override</span><span>,</span><span>!</span><span>cap_mac_admin</span><span>,</span><span>!</span><span>cap_syslog</span><span>,</span><span>!</span><span>cap_wake_alarm</span><span>,</span><span>!</span><span>cap_block_suspend</span><span>,</span><span>!</span><span>cap_audit_read</span></p><p><span>Securebits</span><span>:</span><span> </span><span>00</span><span>/</span><span>0x0</span><span>/</span><span>1</span>'<span>b0</span></p><p><span></span><span>secure</span><span>-</span><span>noroot</span><span>:</span><span> </span><span>no</span><span> </span><span>(</span><span>unlocked</span><span>)</span></p><p><span></span><span>secure</span><span>-</span><span>no</span><span>-</span><span>suid</span><span>-</span><span>fixup</span><span>:</span><span> </span><span>no</span><span> </span><span>(</span><span>unlocked</span><span>)</span></p><p><span></span><span>secure</span><span>-</span><span>keep</span><span>-</span><span>caps</span><span>:</span><span> </span><span>no</span><span> </span><span>(</span><span>unlocked</span><span>)</span></p><p><span></span><span>secure</span><span>-</span><span>no</span><span>-</span><span>ambient</span><span>-</span><span>raise</span><span>:</span><span> </span><span>no</span><span> </span><span>(</span><span>unlocked</span><span>)</span></p><p><span>uid</span><span>=</span><span>0</span><span>(</span><span>root</span><span>)</span><span> </span><span>euid</span><span>=</span><span>0</span><span>(</span><span>root</span><span>)</span></p><p><span>gid</span><span>=</span><span>0</span><span>(</span><span>root</span><span>)</span></p><p><span>groups</span><span>=</span></p><p><span>Guessed </span><span>mode</span><span>:</span><span> </span><span>UNCERTAIN</span><span> </span><span>(</span><span>0</span><span>)</span></p></div></td></tr></tbody></table>

可看到 `Current` 和 `Bounding` 里面有 `cap_sys_admin`。`+ep` 的意思是它们也在 `effective` 和 `permitted` 中。

## 5\. 文件系统的隔离

在容器中只能看到容器里面的文件，而不能看到 host 上面的文件（不map的情况下），做到了隔离。

Linux 使用 tree 的形式组织文件系统，最底层叫做 rootfs, 一般由发行版提供，mount 到 `/` 。然后其他的文件系统 mount 到 `/` 下面。比如，可以将一个外部的 USB 设备 mount 到  `/data` 下面。

`mount(2)`是用来 mount 文件的系统的 syscall。当系统启动的时候，init 进程就会做一些初始化的 mount。

所有的进程都有自己的 mount table，但是大多数情况下都指向了同一个地方，init process 的 mount table。

但是其实可以从 parent 进程继承过来之后，再做一些改变。这样只会影响到它自己。这就是 mount namespace。如果 mount namespace 下面有任何进程修改了 mount table，其他的进程也会受到影响。所以当你在shell mount 一个 usb 设备的时候，GUI 的 file explorer 也会看到这个设备。

### Mount Namespace

一般来说应用在启动的时候不会修改 mount namespace. 比如现在在我的虚拟机中，就有以下的 mount namespace:

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span># cinf | grep mnt</span></p><p><span></span><span>4026531840</span><span>&nbsp;&nbsp;</span><span>mnt</span><span>&nbsp;&nbsp; </span><span>103</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span>,</span><span>1</span><span>,</span><span>103</span><span>,</span><span>104</span><span>,</span><span>112</span><span>,</span><span>1000</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>/</span><span>sbin</span><span>/</span><span>init</span></p><p><span></span><span>4026531860</span><span>&nbsp;&nbsp;</span><span>mnt</span><span>&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span></p><p><span></span><span>4026532162</span><span>&nbsp;&nbsp;</span><span>mnt</span><span>&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>/</span><span>lib</span><span>/</span><span>systemd</span><span>/</span><span>systemd</span><span>-</span><span>udevd</span></p><p><span></span><span>4026532164</span><span>&nbsp;&nbsp;</span><span>mnt</span><span>&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>100</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>/</span><span>lib</span><span>/</span><span>systemd</span><span>/</span><span>systemd</span><span>-</span><span>networkd</span></p><p><span></span><span>4026532183</span><span>&nbsp;&nbsp;</span><span>mnt</span><span>&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>101</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>/</span><span>lib</span><span>/</span><span>systemd</span><span>/</span><span>systemd</span><span>-</span><span>resolved</span></p><p><span></span><span>4026532248</span><span>&nbsp;&nbsp;</span><span>mnt</span><span>&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>/</span><span>lib</span><span>/</span><span>systemd</span><span>/</span><span>systemd</span><span>-</span><span>logind</span></p></div></td></tr></tbody></table>

现在启动一个 container，可以看到有了新的 mount namespace：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span># cinf | grep mnt</span></p><p><span></span><span>4026531840</span><span>&nbsp;&nbsp;</span><span>mnt</span><span>&nbsp;&nbsp; </span><span>102</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span>,</span><span>1</span><span>,</span><span>103</span><span>,</span><span>104</span><span>,</span><span>112</span><span>,</span><span>1000</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>/</span><span>sbin</span><span>/</span><span>init</span></p><p><span></span><span>4026531860</span><span>&nbsp;&nbsp;</span><span>mnt</span><span>&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span></p><p><span></span><span>4026532162</span><span>&nbsp;&nbsp;</span><span>mnt</span><span>&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>/</span><span>lib</span><span>/</span><span>systemd</span><span>/</span><span>systemd</span><span>-</span><span>udevd</span></p><p><span></span><span>4026532164</span><span>&nbsp;&nbsp;</span><span>mnt</span><span>&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>100</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>/</span><span>lib</span><span>/</span><span>systemd</span><span>/</span><span>systemd</span><span>-</span><span>networkd</span></p><p><span></span><span>4026532183</span><span>&nbsp;&nbsp;</span><span>mnt</span><span>&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>101</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>/</span><span>lib</span><span>/</span><span>systemd</span><span>/</span><span>systemd</span><span>-</span><span>resolved</span></p><p><span></span><span>4026532185</span><span>&nbsp;&nbsp;</span><span>mnt</span><span>&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>sh</span></p><p><span></span><span>4026532248</span><span>&nbsp;&nbsp;</span><span>mnt</span><span>&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>/</span><span>lib</span><span>/</span><span>systemd</span><span>/</span><span>systemd</span><span>-</span><span>logind</span></p></div></td></tr></tbody></table>

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span># cinf -namespace 4026532185</span></p><p><span></span><span>PID&nbsp;&nbsp;&nbsp;&nbsp;</span><span>PPID&nbsp;&nbsp; </span><span>NAME&nbsp;&nbsp;</span><span>CMD</span><span>&nbsp;&nbsp;</span><span>NTHREADS&nbsp;&nbsp;</span><span>CGROUPS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>STATE</span></p><p><span></span><span>14013</span><span>&nbsp;&nbsp;</span><span>14003</span><span>&nbsp;&nbsp;</span><span>sh&nbsp;&nbsp;&nbsp;&nbsp;</span><span>sh</span><span>&nbsp;&nbsp; </span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>12</span><span>:</span><span>blkio</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>yoyo</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>S</span><span> </span><span>(</span><span>sleeping</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>11</span><span>:</span><span>pids</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>1000.slice</span><span>/</span><span>session</span><span>-</span><span>35.scope</span><span>/</span><span>yoyo</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>10</span><span>:</span><span>devices</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>yoyo</span><span> </span><span>9</span><span>:</span><span>cpu</span><span>,</span><span>cpuacct</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>yoyo</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>8</span><span>:</span><span>memory</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>1000.slice</span><span>/</span><span>session</span><span>-</span><span>35.scope</span><span>/</span><span>yoyo</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>7</span><span>:</span><span>net_cls</span><span>,</span><span>net_prio</span><span>:</span><span>/</span><span>yoyo</span><span> </span><span>6</span><span>:</span><span>rdma</span><span>:</span><span>/</span><span> </span><span>5</span><span>:</span><span>cpuset</span><span>:</span><span>/</span><span>yoyo</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>4</span><span>:</span><span>freezer</span><span>:</span><span>/</span><span>yoyo</span><span> </span><span>3</span><span>:</span><span>hugetlb</span><span>:</span><span>/</span><span>yoyo</span><span> </span><span>2</span><span>:</span><span>perf_event</span><span>:</span><span>/</span><span>yoyo</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>1</span><span>:</span><span>name</span><span>=</span><span>systemd</span><span>:</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>1000.slice</span><span>/</span><span>session</span><span>-</span><span>35.scope</span><span>/</span><span>yoyo</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span>::</span><span>/</span><span>user</span><span>.</span><span>slice</span><span>/</span><span>user</span><span>-</span><span>1000.slice</span><span>/</span><span>session</span><span>-</span><span>35.scope</span></p></div></td></tr></tbody></table>

在 host 进程上查看 mount info：

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p></div></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span># cat /proc/14013/mounts | sort | uniq</span></p><p><span>cgroup</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>blkio </span><span>cgroup </span><span>ro</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>blkio</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>cgroup</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>cpu</span><span>,</span><span>cpuacct </span><span>cgroup </span><span>ro</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>cpu</span><span>,</span><span>cpuacct</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>cgroup</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>cpuset </span><span>cgroup </span><span>ro</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>cpuset</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>cgroup</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>devices </span><span>cgroup </span><span>ro</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>devices</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>cgroup</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>freezer </span><span>cgroup </span><span>ro</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>freezer</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>cgroup</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>hugetlb </span><span>cgroup </span><span>ro</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>hugetlb</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>cgroup</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>memory </span><span>cgroup </span><span>ro</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>memory</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>cgroup</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>net_cls</span><span>,</span><span>net_prio </span><span>cgroup </span><span>ro</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>net_cls</span><span>,</span><span>net</span><span>_</span>prio<span> </span><span>0</span><span> </span><span>0</span></p><p><span>cgroup</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>perf_event </span><span>cgroup </span><span>ro</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>perf</span><span>_</span>event<span> </span><span>0</span><span> </span><span>0</span></p><p><span>cgroup</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>pids </span><span>cgroup </span><span>ro</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>pids</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>cgroup</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>rdma </span><span>cgroup </span><span>ro</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>rdma</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>cgroup</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup</span><span>/</span><span>systemd </span><span>cgroup </span><span>ro</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>xattr</span><span>,</span><span>name</span><span>=</span><span>systemd</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>/</span><span>dev</span><span>/</span><span>mapper</span><span>/</span><span>vgvagrant</span><span>-</span><span>root</span><span> </span><span>/</span><span> </span><span>ext4 </span><span>ro</span><span>,</span><span>relatime</span><span>,</span><span>errors</span><span>=</span><span>remount</span><span>-</span><span>ro</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>devpts</span><span> </span><span>/</span><span>dev</span><span>/</span><span>console </span><span>devpts </span><span>rw</span><span>,</span><span>nosuid</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>gid</span><span>=</span><span>5</span><span>,</span><span>mode</span><span>=</span><span>620</span><span>,</span><span>ptmxmode</span><span>=</span><span>666</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>devpts</span><span> </span><span>/</span><span>dev</span><span>/</span><span>pts </span><span>devpts </span><span>rw</span><span>,</span><span>nosuid</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>gid</span><span>=</span><span>5</span><span>,</span><span>mode</span><span>=</span><span>620</span><span>,</span><span>ptmxmode</span><span>=</span><span>666</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>mqueue</span><span> </span><span>/</span><span>dev</span><span>/</span><span>mqueue </span><span>mqueue </span><span>rw</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>proc</span><span> </span><span>/</span><span>proc</span><span>/</span><span>bus </span><span>proc </span><span>ro</span><span>,</span><span>relatime</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>proc</span><span> </span><span>/</span><span>proc</span><span>/</span><span>fs </span><span>proc </span><span>ro</span><span>,</span><span>relatime</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>proc</span><span> </span><span>/</span><span>proc</span><span>/</span><span>irq </span><span>proc </span><span>ro</span><span>,</span><span>relatime</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>proc</span><span> </span><span>/</span><span>proc </span><span>proc </span><span>rw</span><span>,</span><span>relatime</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>proc</span><span> </span><span>/</span><span>proc</span><span>/</span><span>sys</span><span> </span><span>proc </span><span>ro</span><span>,</span><span>relatime</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>proc</span><span> </span><span>/</span><span>proc</span><span>/</span><span>sysrq</span><span>-</span><span>trigger </span><span>proc </span><span>ro</span><span>,</span><span>relatime</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>shm</span><span> </span><span>/</span><span>dev</span><span>/</span><span>shm </span><span>tmpfs </span><span>rw</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>size</span><span>=</span><span>65536k</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>sysfs</span><span> </span><span>/</span><span>sys</span><span> </span><span>sysfs </span><span>ro</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>tmpfs</span><span> </span><span>/</span><span>dev </span><span>tmpfs </span><span>rw</span><span>,</span><span>nosuid</span><span>,</span><span>size</span><span>=</span><span>65536k</span><span>,</span><span>mode</span><span>=</span><span>755</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>tmpfs</span><span> </span><span>/</span><span>proc</span><span>/</span><span>acpi </span><span>tmpfs </span><span>ro</span><span>,</span><span>relatime</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>tmpfs</span><span> </span><span>/</span><span>proc</span><span>/</span><span>kcore </span><span>tmpfs </span><span>rw</span><span>,</span><span>nosuid</span><span>,</span><span>size</span><span>=</span><span>65536k</span><span>,</span><span>mode</span><span>=</span><span>755</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>tmpfs</span><span> </span><span>/</span><span>proc</span><span>/</span><span>keys </span><span>tmpfs </span><span>rw</span><span>,</span><span>nosuid</span><span>,</span><span>size</span><span>=</span><span>65536k</span><span>,</span><span>mode</span><span>=</span><span>755</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>tmpfs</span><span> </span><span>/</span><span>proc</span><span>/</span><span>sched_debug </span><span>tmpfs </span><span>rw</span><span>,</span><span>nosuid</span><span>,</span><span>size</span><span>=</span><span>65536k</span><span>,</span><span>mode</span><span>=</span><span>755</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>tmpfs</span><span> </span><span>/</span><span>proc</span><span>/</span><span>scsi </span><span>tmpfs </span><span>ro</span><span>,</span><span>relatime</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>tmpfs</span><span> </span><span>/</span><span>proc</span><span>/</span><span>timer_list </span><span>tmpfs </span><span>rw</span><span>,</span><span>nosuid</span><span>,</span><span>size</span><span>=</span><span>65536k</span><span>,</span><span>mode</span><span>=</span><span>755</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>tmpfs</span><span> </span><span>/</span><span>sys</span><span>/</span><span>firmware </span><span>tmpfs </span><span>ro</span><span>,</span><span>relatime</span><span> </span><span>0</span><span> </span><span>0</span></p><p><span>tmpfs</span><span> </span><span>/</span><span>sys</span><span>/</span><span>fs</span><span>/</span><span>cgroup </span><span>tmpfs </span><span>rw</span><span>,</span><span>nosuid</span><span>,</span><span>nodev</span><span>,</span><span>noexec</span><span>,</span><span>relatime</span><span>,</span><span>mode</span><span>=</span><span>755</span><span> </span><span>0</span><span> </span><span>0</span></p></div></td></tr></tbody></table>

可以看到这个进程的 `/` mount 到了 `/dev/mapper/vagrant-root` 上。

在 host 机器上，查看 mount，会发现这个设备同样 mount 在了 `/` 上。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span># mount | grep /dev/mapper/vgvagrant-root</span></p><p><span>/</span><span>dev</span><span>/</span><span>mapper</span><span>/</span><span>vgvagrant</span><span>-</span><span>root </span><span>on</span><span> </span><span>/</span><span> </span><span>type</span><span> </span><span>ext4</span><span> </span><span>(</span><span>rw</span><span>,</span><span>relatime</span><span>,</span><span>errors</span><span>=</span><span>remount</span><span>-</span><span>ro</span><span>)</span></p></div></td></tr></tbody></table>

所以这里就有了问题：为什么 container 的 rootfs 会和 host 的 rootfs 是一样的呢？这是否意味着 contianer 能读写 host 的文件了呢？contianer 的 rootfs 不应该是 runc 的 pwd 里面的 rootfs 吗？

我们可以看下 container 里面的 `/` 到底是什么。

在 container 里面查看 `/` 的 [inode number:](https://www.kawabangga.com/posts/3561)

然后看下 Host 上运行 runc 所在的 pwd 下面的 rootfs：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span>/</span><span>test_cap</span><span>/</span><span>rootfs</span><span># ls -id /home/vagrant/test_cap/rootfs</span></p><p><span>2883749</span><span> </span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span>/</span><span>test_cap</span><span>/</span><span>rootfs</span></p></div></td></tr></tbody></table>

可以看到，容器里面的 `/` 确实就是 host 上的 `rootfs`。

但是他们是怎么做到都 mount 到 `/dev/mapper/vagrant-root` 的呢？

这里的 “jail” 其实是 privot\_root 提供的。它可以改变 process 的运行时的 rootfs. 相关代码可以查看[这里](https://github.com/opencontainers/runc/blob/master/libcontainer/rootfs_linux.go#L647)。这个 idea 其实来自于 [lxc](https://github.com/lxc/lxc/blob/master/src/lxc/conf.c#L1092)。

### chroot

要做到文件系统的隔离，其实并不一定需要创建一个新的 mount namespace 和 privot\_root 来进行文件系统的隔离，可以直接使用 `chroot(2)` 来 jail 容器进程。chroot 并没有改变任何 mount table，它只是让进程的 `/` 看起来就是一个指定的目录。

关于 chroot 和 privot\_root 的对比可以参考[这里](https://lists.linuxcontainers.org/pipermail/lxc-devel/2011-September/002065.html)。

简单来说，privot\_root 更加彻底和安全。

如果在 runc 使用 chroot，只需要将 {“type”:”mount”} 删掉即可。

也可以删掉这部分，这是为 privot\_root 准备的。

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p></div></td><td><div><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"maskedPaths"</span><span>:</span><span> </span><span>[</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/proc/kcore"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/proc/latency_stats"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/proc/timer_list"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/proc/timer_stats"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/proc/sched_debug"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/sys/firmware"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/proc/scsi"</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>]</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"readonlyPaths"</span><span>:</span><span> </span><span>[</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/proc/asound"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/proc/bus"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/proc/fs"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/proc/irq"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/proc/sys"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/proc/sysrq-trigger"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span></p></div></td></tr></tbody></table>

然后创建一个新的容器，发现依然不能读写 rootfs 之外的东西。

### Bind Mount

Linux 支持 `bind mount`. 就是可以将一个文件目录同时 mount 到多个地方。这样，我们就可以实现在 host 和 container 之间共享文件了。

在 `config.json` 中作出以下修改：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>diff</span><span> </span><span>--</span><span>git</span><span> </span><span>a</span><span>/</span><span>config</span><span>.</span><span>json</span><span> </span><span>b</span><span>/</span><span>config</span><span>.</span><span>json</span></p><p><span>index</span><span> </span><span>25a3154..13ae9bf</span><span> </span><span>100644</span></p><p><span>--</span><span>-</span><span> </span><span>a</span><span>/</span><span>config</span><span>.</span><span>json</span></p><p><span>++</span><span>+</span><span> </span><span>b</span><span>/config.json</span></p><p><span>@@ -129,6 +129,11 @@</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"relatime",</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ro"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "destination": "/m</span><span>y</span><span>_</span>workspace<span>",</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "</span><span>type</span><span>": "</span><span>bind</span><span>",</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "</span><span>source</span><span>": "</span><span>worksapce</span><span>_</span>host<span>",</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "</span><span>options</span><span>" : ["</span><span>bind</span>"<span>]</span></p></div></td></tr></tbody></table>

这样， host 上面的 `/home/vagrant/test_cap/workspace_host` 就会和容器中的 `/my_workspace` 同步了。可以在 host 上面执行：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span>/</span><span>test</span><span>_</span>cap<span># echo hello &gt; workspace_host/world</span></p></div></td></tr></tbody></table>

然后在 container 里面：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span># cat /myworkspace/world</span></p><p><span>hello</span></p></div></td></tr></tbody></table>

Bind 不仅可以用来 mount host 的目录，还可以用来 mount host 上面的 device file。比如可以将 host 的 UBS 设备 mount 到 container 中。

### Docker  Volume

Volume 是 docker 中的概念，OCI 中并没有定义。

本质上它仍然是一个 mount，可以理解为是 docker 帮你管理好这个 mount，你只要通过命令行告诉 docker 要 mount 的东西就好了。

## 6\. User and root

User 和 permission 是 Linux 上面几乎最古老的权限系统了。工作原理简要如下：

1.  系统有很多 users 和 groups
2.  每个文件属于一个 owner 和一个 group
3.  每一个进程属于一个 user 和多个 groups
4.  结合以上三点，每一个文件都有一个 mode，标志了针对三种不同类型的进程的权限控制: owner, group 和 other.

注意 kernel 只关心 uid 和 guid，user name 和 group name 只是给用户看的。

### 执行容器内进程的 uid

`config.json` 文件中的 [User](https://github.com/opencontainers/runtime-spec/blob/master/config.md#user) 字段可以指定容器的进程以什么 uid 来运行，默认是 0，即 root。这个字段不是必须的，如果删去，依然是以 uid=0 运行。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>id</span></p><p><span>uid</span><span>=</span><span>0</span><span>(</span><span>root</span><span>)</span><span> </span><span>gid</span><span>=</span><span>0</span><span>(</span><span>root</span><span>)</span></p></div></td></tr></tbody></table>

在 host 上，uid 也是 0：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>runc </span><span>ps </span><span>xyxy</span></p><p><span>UID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>PID&nbsp;&nbsp;&nbsp;&nbsp;</span><span>PPID</span><span>&nbsp;&nbsp;</span><span>C</span><span> </span><span>STIME </span><span>TTY</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>TIME</span><span> </span><span>CMD</span></p><p><span>root</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>15223</span><span>&nbsp;&nbsp; </span><span>15212</span><span>&nbsp;&nbsp;</span><span>0</span><span> </span><span>07</span><span>:</span><span>55</span><span> </span><span>pts</span><span>/</span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span><span> </span><span>sh</span></p></div></td></tr></tbody></table>

不推荐使用 root 来跑容器。但是好在默认我们的容器进程还受 capability 的限制。不像 host 的 root 一样有很多权限。

但是仍然推荐使用一个非 root 用户来运行容器的进程。通过修改 `config.json` 的 uid/guid 可以控制。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"user"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"uid"</span><span>:</span><span> </span><span>1000</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"gid"</span><span>:</span><span> </span><span>1000</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p></div></td></tr></tbody></table>

然后在容器中可以看到 uid 已经变成 1000 了。

在 host 上可以看到进程的 uid 已经不是 root 了：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>runc </span><span>ps </span><span>xyxy</span></p><p><span>UID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>PID&nbsp;&nbsp;&nbsp;&nbsp;</span><span>PPID</span><span>&nbsp;&nbsp;</span><span>C</span><span> </span><span>STIME </span><span>TTY</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>TIME</span><span> </span><span>CMD</span></p><p><span>vagrant</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>15348</span><span>&nbsp;&nbsp; </span><span>15336</span><span>&nbsp;&nbsp;</span><span>0</span><span> </span><span>11</span><span>:</span><span>12</span><span> </span><span>pts</span><span>/</span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span><span> </span><span>sh</span></p></div></td></tr></tbody></table>

创建容器的时候默认不会创建 user namespace。

### 使用 User namespace 进行 UID/GID mapping

接下来我们创建一个单独的 user namespace.

在开始之前我们先看下 host 上现有的 user namespace:

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>cinf</span><span> </span><span>|</span><span> </span><span>grep </span><span>user</span></p><p><span></span><span>4026531837</span><span>&nbsp;&nbsp;</span><span>user</span><span>&nbsp;&nbsp;</span><span>113</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span>,</span><span>1</span><span>,</span><span>100</span><span>,</span><span>101</span><span>,</span><span>103</span><span>,</span><span>104</span><span>,</span><span>112</span><span>,</span><span>1000</span><span>&nbsp;&nbsp;</span><span>/</span><span>sbin</span><span>/</span><span>init</span></p></div></td></tr></tbody></table>

然后通过修改 config.json 来启用 user namespace. 首先在 `namespaces` 下面添加 user 来启用，然后添加一个 uid/guid mapping：

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p></div></td><td><div><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>}</span><span>,</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>{</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"type"</span><span>:</span><span> </span><span>"user"</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>}</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>]</span><span>,</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"uidMappings"</span><span>:</span><span> </span><span>[</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>{</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"containerID"</span><span>:</span><span> </span><span>0</span><span>,</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"hostID"</span><span>:</span><span> </span><span>1000</span><span>,</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"size"</span><span>:</span><span> </span><span>32000</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>}</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>]</span><span>,</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"gidMappings"</span><span>:</span><span> </span><span>[</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>{</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"containerID"</span><span>:</span><span> </span><span>0</span><span>,</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"hostID"</span><span>:</span><span> </span><span>1000</span><span>,</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"size"</span><span>:</span><span> </span><span>32000</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p></div></td></tr></tbody></table>

然后重新运行容器，再次查看 user namespace:

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>cinf</span><span> </span><span>|</span><span> </span><span>grep </span><span>user</span></p><p><span></span><span>4026531837</span><span>&nbsp;&nbsp;</span><span>user</span><span>&nbsp;&nbsp;</span><span>120</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span>,</span><span>1</span><span>,</span><span>100</span><span>,</span><span>101</span><span>,</span><span>103</span><span>,</span><span>104</span><span>,</span><span>112</span><span>,</span><span>1000</span><span>&nbsp;&nbsp;</span><span>/</span><span>sbin</span><span>/</span><span>init</span></p><p><span></span><span>4026532185</span><span>&nbsp;&nbsp;</span><span>user</span><span>&nbsp;&nbsp;</span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>2000</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>sh</span></p></div></td></tr></tbody></table>

在容器里面，我们看到 uid=1000：

但是在 host 上，这个进程的 pid=2000：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>runc </span><span>ps </span><span>xyxy</span></p><p><span>UID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>PID&nbsp;&nbsp;&nbsp;&nbsp;</span><span>PPID</span><span>&nbsp;&nbsp;</span><span>C</span><span> </span><span>STIME </span><span>TTY</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>TIME</span><span> </span><span>CMD</span></p><p><span>2000</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>15438</span><span>&nbsp;&nbsp; </span><span>15426</span><span>&nbsp;&nbsp;</span><span>0</span><span> </span><span>11</span><span>:</span><span>19</span><span> </span><span>pts</span><span>/</span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span><span> </span><span>sh</span></p></div></td></tr></tbody></table>

这就是 uid/gid mapping 的作用，通过 `/proc` 文件也可以查看 mapping 的设置：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>cat</span><span> </span><span>/</span><span>proc</span><span>/</span><span>15438</span><span>/</span><span>uid</span><span>_</span>map</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>1000</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>32000</span></p></div></td></tr></tbody></table>

通过设置容器内的进程的 uid，我们就可以控制他们对于文件的权限。比如如果文件的 owner 是 root，我们可以通过设置 uid 来让容器内的进程不可读这个文件。

一般不推荐使用 root 运行容器的进程，如果一定要用的话，使用 user namespace 将它隔离出去。

在同一个容器内运行多个进程的场景中，也可以通过 user namespace 来单独控制容器内的进程。

## 7\. 网络

在网络方面，OCI Runtime Spec 只做了创建和假如 [network namespace](https://man7.org/linux/man-pages/man7/network_namespaces.7.html), 其他的工作需要通过 [hooks](https://github.com/opencontainers/runtime-spec/blob/master/config.md#posix-platform-hooks) 完成，需要用户在容器的运行时的不同的阶段来进行自定义。

使用默认的 `config.json` ，就只有一个 `loop device` ，没有 `eth0` ，所以也就不能连接到容器外面的网络。但是我们可以通过 `netns` 作为 hook 来提供网络。

首先，在宿主机上，下载 netns 到 `/usr/local/bin` 中。因为 hooks 在 host 中执行，所以这些 Binary 要放在 host 中而不是容器中，容器的 rootfs 不需要任何东西。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span># Export the sha256sum for verification.</span></p><p><span>$</span><span> </span><span>export </span><span>NETNS_SHA256</span><span>=</span><span>"8a3a48183ed5182a0619b18f05ef42ba5c4c3e3e499a2e2cb33787bd7fbdaa5c"</span></p><p><span># Download and check the sha256sum.</span></p><p><span>$</span><span> </span><span>curl</span><span> </span><span>-</span><span>fSL</span><span> </span><span>"https://github.com/genuinetools/netns/releases/download/v0.5.3/netns-linux-amd64"</span><span> </span><span>-</span><span>o</span><span> </span><span>"/usr/local/bin/netns"</span><span> </span><span>\</span></p><p><span></span><span>&amp;&amp;</span><span> </span><span>echo</span><span> </span><span>"${NETNS_SHA256}&nbsp;&nbsp;/usr/local/bin/netns"</span><span> </span><span>|</span><span> </span><span>sha256sum</span><span> </span><span>-</span><span>c</span><span> </span><span>-</span><span> </span><span>\</span></p><p><span></span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>a</span><span>+</span><span>x</span><span> </span><span>"/usr/local/bin/netns"</span></p><p><span>$</span><span> </span><span>echo</span><span> </span><span>"netns installed!"</span></p><p><span># Run it!</span></p><p><span>$</span><span> </span><span>netns</span><span> </span><span>-</span><span>h</span></p></div></td></tr></tbody></table>

### 使用 netns 设置 bridge network

在 `config.json` 中作出如下修改，除了 hooks，还需要 `CAP_NET_RAW`  capability, 这样我们才可以在容器中使用 ping。

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p></div></td><td><div><p><span>binchen</span><span>@</span><span>m</span><span>:</span><span>~</span><span>/</span><span>container</span><span>/</span><span>runc</span><span>$</span><span> </span><span>git </span><span>diff</span></p><p><span>diff</span><span> </span><span>--</span><span>git</span><span> </span><span>a</span><span>/</span><span>config</span><span>.</span><span>json</span><span> </span><span>b</span><span>/</span><span>config</span><span>.</span><span>json</span></p><p><span>index</span><span> </span><span>25a3154..d1c0fb2</span><span> </span><span>100644</span></p><p><span>--</span><span>-</span><span> </span><span>a</span><span>/</span><span>config</span><span>.</span><span>json</span></p><p><span>++</span><span>+</span><span> </span><span>b</span><span>/</span><span>config</span><span>.</span><span>json</span></p><p><span>@</span><span>@</span><span> </span><span>-</span><span>18</span><span>,</span><span>12</span><span> </span><span>+</span><span>18</span><span>,</span><span>16</span><span> </span><span>@</span><span>@</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"bounding"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_AUDIT_WRITE"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_KILL"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"CAP_NET_BIND_SERVICE"</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"CAP_NET_BIND_SERVICE"</span><span>,</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"CAP_NET_RAW"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"effective"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_AUDIT_WRITE"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_KILL"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"CAP_NET_BIND_SERVICE"</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"CAP_NET_BIND_SERVICE"</span><span>,</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"CAP_NET_RAW"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"inheritable"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_AUDIT_WRITE"</span><span>,</span></p><p><span>@</span><span>@</span><span> </span><span>-</span><span>33</span><span>,</span><span>7</span><span> </span><span>+</span><span>37</span><span>,</span><span>9</span><span> </span><span>@</span><span>@</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"permitted"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_AUDIT_WRITE"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_KILL"</span><span>,</span></p><p><span>-</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"CAP_NET_BIND_SERVICE"</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"CAP_NET_BIND_SERVICE"</span><span>,</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"CAP_NET_RAW"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ambient"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"CAP_AUDIT_WRITE"</span><span>,</span></p><p><span>@</span><span>@</span><span> </span><span>-</span><span>131</span><span>,</span><span>6</span><span> </span><span>+</span><span>137</span><span>,</span><span>16</span><span> </span><span>@</span><span>@</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>+</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"hooks"</span><span>:</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>{</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"prestart"</span><span>:</span><span> </span><span>[</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>{</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"path"</span><span>:</span><span> </span><span>"/usr/local/bin/netns"</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>}</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>]</span></p><p><span>+</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>}</span><span>,</span></p><p><span>+</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"linux"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"resources"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"devices"</span><span>:</span><span> </span><span>[</span></p></div></td></tr></tbody></table>

然后再启动一个新的容器。

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p></div></td><td><div><p><span>root</span><span>@</span><span>vagrant</span><span>:</span><span>/</span><span>home</span><span>/</span><span>vagrant</span><span>/</span><span>test</span><span>_</span>cap<span># runc run xyxy</span></p><p><span>/</span><span> </span><span># ifconfig</span></p><p><span>eth0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Link </span><span>encap</span><span>:</span><span>Ethernet&nbsp;&nbsp;</span><span>HWaddr </span><span>EA</span><span>:</span><span>8B</span><span>:</span><span>9D</span><span>:</span><span>06</span><span>:</span><span>61</span><span>:</span><span>E5</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>inet </span><span>addr</span><span>:</span><span>172.19.0.2</span><span>&nbsp;&nbsp;</span><span>Bcast</span><span>:</span><span>172.19.255.255</span><span>&nbsp;&nbsp;</span><span>Mask</span><span>:</span><span>255.255.0.0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>inet6 </span><span>addr</span><span>:</span><span> </span><span>fe80</span><span>::</span><span>e88b</span><span>:</span><span>9dff</span><span>:</span><span>fe06</span><span>:</span><span>61e5</span><span>/</span><span>64</span><span> </span><span>Scope</span><span>:</span><span>Link</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>UP </span><span>BROADCAST </span><span>RUNNING </span><span>MULTICAST&nbsp;&nbsp;</span><span>MTU</span><span>:</span><span>1500</span><span>&nbsp;&nbsp;</span><span>Metric</span><span>:</span><span>1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>RX </span><span>packets</span><span>:</span><span>10</span><span> </span><span>errors</span><span>:</span><span>0</span><span> </span><span>dropped</span><span>:</span><span>0</span><span> </span><span>overruns</span><span>:</span><span>0</span><span> </span><span>frame</span><span>:</span><span>0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>TX </span><span>packets</span><span>:</span><span>7</span><span> </span><span>errors</span><span>:</span><span>0</span><span> </span><span>dropped</span><span>:</span><span>0</span><span> </span><span>overruns</span><span>:</span><span>0</span><span> </span><span>carrier</span><span>:</span><span>0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>collisions</span><span>:</span><span>0</span><span> </span><span>txqueuelen</span><span>:</span><span>1000</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>RX </span><span>bytes</span><span>:</span><span>880</span><span> </span><span>(</span><span>880.0</span><span> </span><span>B</span><span>)</span><span>&nbsp;&nbsp;</span><span>TX </span><span>bytes</span><span>:</span><span>570</span><span> </span><span>(</span><span>570.0</span><span> </span><span>B</span><span>)</span></p><p><span>lo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Link </span><span>encap</span><span>:</span><span>Local </span><span>Loopback</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>inet </span><span>addr</span><span>:</span><span>127.0.0.1</span><span>&nbsp;&nbsp;</span><span>Mask</span><span>:</span><span>255.0.0.0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>inet6 </span><span>addr</span><span>:</span><span> </span><span>::</span><span>1</span><span>/</span><span>128</span><span> </span><span>Scope</span><span>:</span><span>Host</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>UP </span><span>LOOPBACK </span><span>RUNNING&nbsp;&nbsp;</span><span>MTU</span><span>:</span><span>65536</span><span>&nbsp;&nbsp;</span><span>Metric</span><span>:</span><span>1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>RX </span><span>packets</span><span>:</span><span>0</span><span> </span><span>errors</span><span>:</span><span>0</span><span> </span><span>dropped</span><span>:</span><span>0</span><span> </span><span>overruns</span><span>:</span><span>0</span><span> </span><span>frame</span><span>:</span><span>0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>TX </span><span>packets</span><span>:</span><span>0</span><span> </span><span>errors</span><span>:</span><span>0</span><span> </span><span>dropped</span><span>:</span><span>0</span><span> </span><span>overruns</span><span>:</span><span>0</span><span> </span><span>carrier</span><span>:</span><span>0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>collisions</span><span>:</span><span>0</span><span> </span><span>txqueuelen</span><span>:</span><span>1000</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>RX </span><span>bytes</span><span>:</span><span>0</span><span> </span><span>(</span><span>0.0</span><span> </span><span>B</span><span>)</span><span>&nbsp;&nbsp;</span><span>TX </span><span>bytes</span><span>:</span><span>0</span><span> </span><span>(</span><span>0.0</span><span> </span><span>B</span><span>)</span></p></div></td></tr></tbody></table>

可以看到除了 `loop` 之外，有了一个 `eth0` device.

也可以 ping 了：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>/</span><span> </span><span># ping 216.58.199.68</span></p><p><span>PING</span><span> </span><span>216.58.199.68</span><span> </span><span>(</span><span>216.58.199.68</span><span>)</span><span>:</span><span> </span><span>56</span><span> </span><span>data </span><span>bytes</span></p><p><span>64</span><span> </span><span>bytes </span><span>from</span><span> </span><span>216.58.199.68</span><span>:</span><span> </span><span>seq</span><span>=</span><span>0</span><span> </span><span>ttl</span><span>=</span><span>55</span><span> </span><span>time</span><span>=</span><span>18.382</span><span> </span><span>ms</span></p><p><span>64</span><span> </span><span>bytes </span><span>from</span><span> </span><span>216.58.199.68</span><span>:</span><span> </span><span>seq</span><span>=</span><span>1</span><span> </span><span>ttl</span><span>=</span><span>55</span><span> </span><span>time</span><span>=</span><span>17.936</span><span> </span><span>ms</span></p></div></td></tr></tbody></table>

### Bridge, Veth, Route and iptable/NAT

当一个 hook 创建的时候，container runtime 会将 container 的 state 传给 hook，包括 container的 pid, namespace 等。然后 hook（在这里就是 `netns` ）就会通过这个 pid 来找到 network namespace，然后 `netns` 会做以下几件事：

1.  创建一个 linux bridge，默认的名字是 `netns0` ，并且设置 `MASQUERADE` rule；
2.  创建一个 veth pair，一端连接 `netns0` ，另一端连接 container network namespace, 名字在 container 里面是 `eth0`;
3.  给 container 里面的 `eth0` 分配一个 ip，然后设置 route table.

#### bridge and interfaces

`netns0` 创建的时候有两个 interfaces，名字是 `netnsv0-$(containerPid)`：（brctl 需要通过 `apt install bridge-utils` 安装）

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>brctl </span><span>show </span><span>netns0</span></p><p><span>bridge </span><span>name&nbsp;&nbsp;&nbsp;&nbsp;</span><span>bridge </span><span>id</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>STP </span><span>enabled&nbsp;&nbsp;&nbsp;&nbsp;</span><span>interfaces</span></p><p><span>netns0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>8000.f2df1fb10980</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>no&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>netnsv0</span><span>-</span><span>8179</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>netnsv0</span><span>-</span><span>10577</span></p></div></td></tr></tbody></table>

`netnsv0-8179` 是 veth pair 其中的一个，连接 bridge，另一个 endpoint 是 container 中的。

#### vthe pair

在 host 中，`netnsv0-8179` 的 index 是7：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>ethtool</span><span> </span><span>-</span><span>S</span><span> </span><span>netnsv0</span><span>-</span><span>8179</span></p><p><span>NIC </span><span>statistics</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>peer_ifindex</span><span>:</span><span> </span><span>7</span></p></div></td></tr></tbody></table>

然后在 container 中，etch0 的 index 也是7.

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>/</span><span> </span><span># ip a</span></p><p><span>1</span><span>:</span><span> </span><span>lo</span><span>:</span><span>&nbsp;&nbsp;</span><span>mtu</span><span> </span><span>65536</span><span> </span><span>qdisc </span><span>noqueue </span><span>qlen</span><span> </span><span>1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>link</span><span>/</span><span>loopback</span><span> </span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span><span> </span><span>brd</span><span> </span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span><span>:</span><span>00</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>inet</span><span> </span><span>127.0.0.1</span><span>/</span><span>8</span><span> </span><span>scope </span><span>host </span><span>lo</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>valid_lft </span><span>forever </span><span>preferred_lft </span><span>forever</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>inet6</span><span> </span><span>::</span><span>1</span><span>/</span><span>128</span><span> </span><span>scope </span><span>host</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>valid_lft </span><span>forever </span><span>preferred_lft </span><span>forever</span></p><p><span>7</span><span>:</span><span> </span><span>eth0</span><span>@</span><span>if8</span><span>:</span><span>&nbsp;&nbsp;</span><span>mtu</span><span> </span><span>1500</span><span> </span><span>qdisc </span><span>noqueue </span><span>qlen</span><span> </span><span>1000</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>link</span><span>/</span><span>ether</span><span> </span><span>8e</span><span>:</span><span>f3</span><span>:</span><span>5c</span><span>:</span><span>d8</span><span>:</span><span>ca</span><span>:</span><span>2b</span><span> </span><span>brd </span><span>ff</span><span>:</span><span>ff</span><span>:</span><span>ff</span><span>:</span><span>ff</span><span>:</span><span>ff</span><span>:</span><span>ff</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>inet</span><span> </span><span>172.19.0.2</span><span>/</span><span>16</span><span> </span><span>brd</span><span> </span><span>172.19.255.255</span><span> </span><span>scope </span><span>global</span><span> </span><span>eth0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>valid_lft </span><span>forever </span><span>preferred_lft </span><span>forever</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>inet6 </span><span>fe80</span><span>::</span><span>8cf3</span><span>:</span><span>5cff</span><span>:</span><span>fed8</span><span>:</span><span>ca2b</span><span>/</span><span>64</span><span> </span><span>scope </span><span>link</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>valid_lft </span><span>forever </span><span>preferred_lft </span><span>forever</span></p></div></td></tr></tbody></table>

所以可以确认容器里面的 `eth0` 和 host 的 `netnsv0-8179` 是一对 pair。

同理可以确认 `netnsv0-10577` 是和 container 10577 中的 `eth0` 是一对 pair。

到这里我们知道容器是如何和 host 通过 veth pair 搭建 bridge 的。有了 network interfaces，还需要 route table 和 iptables.

#### Route Table

container 里面的 routing table 如下：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>/</span><span> </span><span># route</span></p><p><span>Kernel </span><span>IP </span><span>routing </span><span>table</span></p><p><span>Destination&nbsp;&nbsp;&nbsp;&nbsp; </span><span>Gateway&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>Genmask&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>Flags </span><span>Metric </span><span>Ref&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Use </span><span>Iface</span></p><p><span>default</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>172.19.0.1</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0.0.0.0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>UG</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span> </span><span>eth0</span></p><p><span>172.19.0.0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>*</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>255.255.0.0</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>U</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span> </span><span>eth0</span></p></div></td></tr></tbody></table>

可以看到所有的流量都从 eth0 到 gateway, 即 bridge `netns0`：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>/</span><span> </span><span># ip route get 216.58.199.68 from 172.19.0.2</span></p><p><span>216.58.199.68</span><span> </span><span>from</span><span> </span><span>172.19.0.2</span><span> </span><span>via</span><span> </span><span>172.19.0.1</span><span> </span><span>dev </span><span>eth0</span></p></div></td></tr></tbody></table>

在 host 上：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>route</span></p><p><span>Kernel </span><span>IP </span><span>routing </span><span>table</span></p><p><span>Destination&nbsp;&nbsp;&nbsp;&nbsp; </span><span>Gateway&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>Genmask&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>Flags </span><span>Metric </span><span>Ref&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Use </span><span>Iface</span></p><p><span>default</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>192</span><span>-</span><span>168</span><span>-</span><span>1</span><span>-</span><span>1</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0.0.0.0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>UG</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span> </span><span>wlan0</span></p><p><span>172.19.0.0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>*</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>255.255.0.0</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>U</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span> </span><span>netns0</span></p><p><span>192.168.1.0</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>*</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>255.255.255.0</span><span>&nbsp;&nbsp; </span><span>U</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>9</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span> </span><span>wlan0</span></p><p><span>192.168.122.0</span><span>&nbsp;&nbsp; </span><span>*</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>255.255.255.0</span><span>&nbsp;&nbsp; </span><span>U</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>0</span><span> </span><span>virbr0</span></p></div></td></tr></tbody></table>

以及：

<table><tbody><tr><td data-settings="show"></td><td><div><p><span>$</span><span> </span><span>ip </span><span>route </span><span>get</span><span> </span><span>216.58.199.68</span><span> </span><span>from</span><span> </span><span>172.19.0.1</span></p><p><span>216.58.199.68</span><span> </span><span>from</span><span> </span><span>172.19.0.1</span><span> </span><span>via</span><span> </span><span>192.168.1.1</span><span> </span><span>dev </span><span>wlan0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>cache</span></p></div></td></tr></tbody></table>

`192.168.1.1` 是 home route，一个真实的 bridge.

总结起来，ping 的时候，从 container 中，包会从 `netns` 的 virtual bridge `netns` ，发送到一个真正的 route gateway，然后到外网去。

#### iptable/nat

`netns` 做的另一个事情是设置 MASQUERADE，这样所有从 container 发出去的包（source是 `172.19.0.0/16` ）都会被 NAT，这样外面只会看到这个包是从 host 来的，而不知道是否来自于一个 container，只能看到 host 的 IP。

<table><tbody><tr><td data-settings="show"></td><td><div><p><span># sudo iptables -t nat --list</span></p><p><span>Chain </span><span>POSTROUTING</span><span> </span><span>(</span><span>policy </span><span>ACCEPT</span><span>)</span></p><p><span>target&nbsp;&nbsp;&nbsp;&nbsp; </span><span>prot&nbsp;&nbsp;</span><span>opt </span><span>source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span>MASQUERADE&nbsp;&nbsp;</span><span>all</span><span>&nbsp;&nbsp;</span><span>--</span><span>&nbsp;&nbsp;</span><span>172.19.0.0</span><span>/</span><span>16</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>anywhere</span></p></div></td></tr></tbody></table>

[![](https://www.kawabangga.com/wp-content/uploads/2021/04/docker-stuff.png)](https://www.kawabangga.com/wp-content/uploads/2021/04/docker-stuff.png)

___

至此，容器用到的一些技术基本上就讲完了。所以说容器本质上是使用 Linux 提供的一些技术来实现进程的隔离，对于 host 来说，它仍然只是一个普通的进程而已。

参考资料：

主要是一些 Linux 手册，以及最主要的，Bin Chen 的博客：[Understand Container](https://pierrchen.blogspot.com/2018/08/understand-container-index.html). 本文基本上是我在学习他的博客的笔记。