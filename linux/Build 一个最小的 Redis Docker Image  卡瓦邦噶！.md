好吧，我承认这么说可能违反了广告法，但是……它确实挺小的。

[![](https://www.kawabangga.com/wp-content/uploads/2021/07/minimal-redis-docker.png)](https://www.kawabangga.com/wp-content/uploads/2021/07/minimal-redis-docker.png)

可以对比一组数据：

-   官方的 Redis 镜像：105MB
-   官方的基于 alpine 的 Redis 镜像：32.3MB
-   在 ubuntu 下面用默认配置 Build 出来的 redis-server binary：13M
-   一个什么都没有的 alpine:latest docker 镜像：5.6MB
-   上图中的 Redis 镜像：1.69MB

所以……可以说，确实挺小了。

当然生产环境肯定不差 100M 这点空间，还是带上一些常用的工具在生产环境跑比较好。本文只是在玩 Nix 时候的自娱自乐，没有什么实际意义。

这个镜像是用 Nix build 的，实际上，就是玩了一下 Nix 网站上的 [Cover Demo](https://nixos.org/#asciinema-demo-cover)。用到的手段有：

1.  使用 Nix 来 build 这个 image；
2.  编译的时候关闭了 systemd 的支持，Docker 里面不需要这种东西；
3.  使用 musl 静态链接编译；
4.  把除了 redis-server 之外的东西删除掉；
5.  编译完成使用 `strip -s` 对最终的 binary 再次做删减。

## 具体的编译方法

首先在 Nix 创建一个文件，来编译 Redis，这里实际上使用的 Nix 打包好的 Redis，我只是对其通过 `preBuild` 和 `postInstall` 做了一些操作，替换 musl 和 strip 之类的。

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p></div></td><td><div><p>[nix-shell:~]$<span> </span>cat<span> </span>redis-minimal.nix</p><p>{<span> </span>pkgs<span> </span>?<span> </span>import<span> </span><span>&lt;</span>nixpkgs<span>&gt;</span><span> </span>{}</p><p>}:</p><p>pkgs.redis.overrideAttrs<span> </span>(old:<span> </span>{</p><p><span>&nbsp;&nbsp;</span>#<span> </span>no<span> </span>need<span> </span>for<span> </span>systemd<span> </span>support<span> </span>in<span> </span>our<span> </span>docker<span> </span>image</p><p><span>&nbsp;&nbsp;</span>makeFlags<span> </span>=<span> </span>old.makeFlags<span> </span>++<span> </span>["USE_SYSTEMD=no"];</p><p><span>&nbsp;&nbsp;</span>#<span> </span>build<span> </span>static<span> </span>binary<span> </span>with<span> </span>musl</p><p><span>&nbsp;&nbsp;</span>preBuild<span> </span>=<span> </span>''</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span>makeFlagsArray=(PREFIX="$out"</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>CC="${pkgs.musl.dev}/bin/musl-gcc<span> </span>-static"</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>CFLAGS="-I${pkgs.musl.dev}/include"</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>LDFLAGS="-L${pkgs.musl.dev}/lib")</p><p><span>&nbsp;&nbsp;</span>'';</p><p><span>&nbsp;&nbsp;</span>#<span> </span>Let's<span> </span>remove<span> </span>some<span> </span>binaries<span> </span>which<span> </span>we<span> </span>don't<span> </span>need</p><p><span>&nbsp;&nbsp;</span>postInstall<span> </span>=<span> </span>''</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp; </span>rm<span> </span>-f<span> </span>$out/bin/redis-{benchmark,check-*,cli,sentinel}</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp; </span>strip<span> </span>-s<span> </span>$out/bin/redis-server</p><p><span>&nbsp;&nbsp;</span>'';</p><p>})</p></div></td></tr></tbody></table>

然后再需要一个文件描述如何 build docker image：

<table><tbody><tr><td data-settings="show"></td><td><div><p>[nix-shell:~]$<span> </span>cat<span> </span>docker-redis-minimal.nix</p><p>{<span> </span>pkgs<span> </span>?<span> </span>import<span> </span><span>&lt;</span>nixpkgs<span>&gt;</span><span> </span>{<span> </span>system<span> </span>=<span> </span>"x86_64-linux";}</p><p>}:<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>#<span> </span>nixpkgs<span> </span>package<span> </span>set</p><p>let</p><p><span>&nbsp;&nbsp;</span>redisMinimal<span> </span>=<span> </span>import<span> </span>./redis-minimal.nix<span> </span>{<span> </span>inherit<span> </span>pkgs;<span> </span>};</p><p>in</p><p>pkgs.dockerTools.buildLayeredImage<span> </span>{<span> </span>#<span> </span>helper<span> </span>to<span> </span>build<span> </span>docker<span> </span>image</p><p><span>&nbsp;&nbsp;</span>name<span> </span>=<span> </span>"nix-redis-minimal";<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>#<span> </span>give<span> </span>docker<span> </span>image<span> </span>a<span> </span>name</p><p><span>&nbsp;&nbsp;</span>tag<span> </span>=<span> </span>"latest";<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>#<span> </span>provide<span> </span>a<span> </span>tag</p><p><span>&nbsp;&nbsp;</span>contents<span> </span>=<span> </span>[<span> </span>redisMinimal<span> </span>];<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>#<span> </span>use<span> </span>redisMinimal<span> </span>package</p><p>}</p></div></td></tr></tbody></table>

非常简单，以至于不需要解释。

然后运行下面这个命令，build 就可以了。因为我已经 build 好了，所以 Nix 不会再出现 build 的日志。

<table><tbody><tr><td data-settings="show"></td><td><div><p>[nix-shell:~]$<span> </span>nix-build<span> </span>docker-redis-minimal.nix<span> </span>-o<span> </span>./result</p><p>/nix/store/42frnm57499800z3mpwf05ab37mam1r0-docker-image-nix-redis-minimal.tar.gz</p></div></td></tr></tbody></table>

在 [Docker (容器) 的原理](https://www.kawabangga.com/posts/4224) 曾经解释过，Docker image 本质上就是一个 tar 包。我们使用 `docker load -i ./result` 可以 load 这个 image。然后就可以运行了：

<table><tbody><tr><td data-settings="show"></td><td><div><p>[nix-shell:~]$<span> </span>docker<span> </span>load<span> </span>-i<span> </span>result</p><p>Loaded<span> </span>image:<span> </span>nix-redis-minimal:latest</p><p>[nix-shell:~/export-docker-image]$<span> </span>docker<span> </span>images</p><p>REPOSITORY<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>TAG<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IMAGE<span> </span>ID<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>CREATED<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>SIZE</p><p>nix-redis-minimal<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>latest<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>433cad4ad790<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>51<span> </span>years<span> </span>ago<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>1.69MB</p><p>[nix-shell:~]$<span> </span>docker<span> </span>run<span> </span>nix-redis-minimal:latest<span> </span>redis-server</p><p>1:C<span> </span>19<span> </span>Jul<span> </span>2021<span> </span>16:37:09.847<span> </span>#<span> </span>oO0OoO0OoO0Oo<span> </span>Redis<span> </span>is<span> </span>starting<span> </span>oO0OoO0OoO0Oo</p><p>1:C<span> </span>19<span> </span>Jul<span> </span>2021<span> </span>16:37:09.847<span> </span>#<span> </span>Redis<span> </span>version=5.0.7,<span> </span>bits=64,<span> </span>commit=00000000,<span> </span>modified=0,<span> </span>pid=1,<span> </span>just<span> </span>started</p><p>1:C<span> </span>19<span> </span>Jul<span> </span>2021<span> </span>16:37:09.847<span> </span>#<span> </span>Warning:<span> </span>no<span> </span>config<span> </span>file<span> </span>specified,<span> </span>using<span> </span>the<span> </span>default<span> </span>config.<span> </span>In<span> </span>order<span> </span>to<span> </span>specify<span> </span>a<span> </span>config<span> </span>file<span> </span>use<span> </span>redis-server<span> </span>/path/to/redis.conf</p><p>1:M<span> </span>19<span> </span>Jul<span> </span>2021<span> </span>16:37:09.848<span> </span>*<span> </span>Running<span> </span>mode=standalone,<span> </span>port=6379.</p><p>1:M<span> </span>19<span> </span>Jul<span> </span>2021<span> </span>16:37:09.848<span> </span>#<span> </span>Server<span> </span>initialized</p><p>1:M<span> </span>19<span> </span>Jul<span> </span>2021<span> </span>16:37:09.848<span> </span>#<span> </span>WARNING<span> </span>overcommit_memory<span> </span>is<span> </span>set<span> </span>to<span> </span>0!<span> </span>Background<span> </span>save<span> </span>may<span> </span>fail<span> </span>under<span> </span>low<span> </span>memory<span> </span>condition.<span> </span>To<span> </span>fix<span> </span>this<span> </span>issue<span> </span>add<span> </span>'vm.overcommit_memory<span> </span>=<span> </span>1'<span> </span>to<span> </span>/etc/sysctl.conf<span> </span>and<span> </span>then<span> </span>reboot<span> </span>or<span> </span>run<span> </span>the<span> </span>command<span> </span>'sysctl<span> </span>vm.overcommit_memory=1'<span> </span>for<span> </span>this<span> </span>to<span> </span>take<span> </span>effect.</p><p>1:M<span> </span>19<span> </span>Jul<span> </span>2021<span> </span>16:37:09.848<span> </span>#<span> </span>WARNING<span> </span>you<span> </span>have<span> </span>Transparent<span> </span>Huge<span> </span>Pages<span> </span>(THP)<span> </span>support<span> </span>enabled<span> </span>in<span> </span>your<span> </span>kernel.<span> </span>This<span> </span>will<span> </span>create<span> </span>latency<span> </span>and<span> </span>memory<span> </span>usage<span> </span>issues<span> </span>with<span> </span>Redis.<span> </span>To<span> </span>fix<span> </span>this<span> </span>issue<span> </span>run<span> </span>the<span> </span>command<span> </span>'echo<span> </span>never<span> </span><span>&gt;</span><span> </span>/sys/kernel/mm/transparent_hugepage/enabled'<span> </span>as<span> </span>root,<span> </span>and<span> </span>add<span> </span>it<span> </span>to<span> </span>your<span> </span>/etc/rc.local<span> </span>in<span> </span>order<span> </span>to<span> </span>retain<span> </span>the<span> </span>setting<span> </span>after<span> </span>a<span> </span>reboot.<span> </span>Redis<span> </span>must<span> </span>be<span> </span>restarted<span> </span>after<span> </span>THP<span> </span>is<span> </span>disabled.</p><p>1:M<span> </span>19<span> </span>Jul<span> </span>2021<span> </span>16:37:09.848<span> </span>*<span> </span>Ready<span> </span>to<span> </span>accept<span> </span>connections</p></div></td></tr></tbody></table>

可能你发现了这个 image 有一些奇怪：Created 51 years ago. 其实这是对的。因为 Nix 号称是完全 reproducible 的，但是 image 如果有一个创建时间的话，那么每次 build 出来的产物都会因为这个创建时间，而导致每次的产物 hash 都不一样。所以 Nix 将 Docker image 产物的 Created 时间设置成 0 了。即 timestamp = 0.

## 看看这个镜像里面都有什么？

读者可以在 [Docker hub](https://hub.docker.com/repository/docker/laixintao/redis-minimal) 上下载这个镜像，然后使用 `docker save` 将它保存成 tar 再解压，看看里面都有什么。我这里直接去解压 Nix build 好的 image，每一层 layer 下面的 `layer.tar` 也都解压到对应的 layer 下面了。

可以看到，里面一层只有一个 redis-server 的 binary，上面一层是一个 bianry 的符号链接。符号链接是 Nix 的逻辑，符号链接很小，就懒得去删除了。

<table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p></div></td><td><div><p>[nix-shell:~/export-docker-image]$<span> </span>tree</p><p>.</p><p>├──<span> </span>42frnm57499800z3mpwf05ab37mam1r0-docker-image-nix-redis-minimal.tar.gz</p><p>├──<span> </span>433cad4ad790679879357e81194fa7502f7688edfe5b7ff64a4f59edfed3f84d.json</p><p>├──<span> </span>83d967dde8785f9b8efc694109992e72f3a9ab6a1b953519e4b892633fd01b1d</p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span>bin</p><p>│&nbsp;&nbsp;<span> </span>│&nbsp;&nbsp;<span> </span>└──<span> </span>redis-server<span> </span>-<span>&gt;</span><span> </span>/nix/store/h25xxpbif767cwhiqxk9z3gp1rbbx6fr-redis-5.0.7/bin/redis-server</p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span>json</p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span>layer.tar</p><p>│&nbsp;&nbsp;<span> </span>└──<span> </span>VERSION</p><p>├──<span> </span>8f7098124197b3823e91dd99eb3cd89853d3ec03448689f2a3f283b261551734</p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span>json</p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span>layer.tar</p><p>│&nbsp;&nbsp;<span> </span>├──<span> </span>nix</p><p>│&nbsp;&nbsp;<span> </span>│&nbsp;&nbsp;<span> </span>└──<span> </span>store</p><p>│&nbsp;&nbsp;<span> </span>│&nbsp;&nbsp;<span>&nbsp;&nbsp;&nbsp;&nbsp; </span>└──<span> </span>h25xxpbif767cwhiqxk9z3gp1rbbx6fr-redis-5.0.7</p><p>│&nbsp;&nbsp;<span> </span>│&nbsp;&nbsp;<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>└──<span> </span>bin</p><p>│&nbsp;&nbsp;<span> </span>│&nbsp;&nbsp;<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>└──<span> </span>redis-server</p><p>│&nbsp;&nbsp;<span> </span>└──<span> </span>VERSION</p><p>├──<span> </span>manifest.json</p><p>└──<span> </span>repositories</p><p>7<span> </span>directories,<span> </span>12<span> </span>files</p></div></td></tr></tbody></table>

## 体验这个镜像

我把这个镜像放到了 [Docker hub](https://hub.docker.com/repository/docker/laixintao/redis-minimal) 上。可以直接运行 `docker run laixintao/redis-minimal:v1 redis-server` 来体验一下。

[Docker] 在 NixOS 里面的安装可以参考[这里](https://nixos.wiki/wiki/Docker)。